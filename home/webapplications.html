<html>
	<head>
		<title>COPE - Web Application Trail</title>
		<meta name="keywords" content="Persistence, Java">
		<meta name="description" content="COPE - a persistence framework for Java">
		<link rel="stylesheet" href="cope.css">
	</head>
	<body>
		<a href="http://www.exedio.com/">
			<img src="exedio.png" class="exedio">
		</a>
		<h1><a href="index.html">COPE</a></h1>
		<div>Cope with Object Persistence</div>
		
		<h2>Web Application Trail</h2>
		<a href="http://sourceforge.net/">
			<img src="http://sourceforge.net/sflogo.php?group_id=152867&amp;type=1"
				class="sf" alt="SourceForge.net Logo" />
		</a>
		<div>
			COPE itself doesn't care,
			whether it runs in a web container or not.
			However it provides some additional convenience,
			when used within web applications.
		</div>
		<h3><a name="contents">Contents</a></h3>
		<ul>
			<li><a href="#initialize">Initialization</a></li>
			<li><a href="#transactions">Transactions</a></li>
			<li><a href="#console">COPE Console</a></li>
			<li><a href="#copernica">Copernica</a></li>
			<li><a href="#further">Further Reading</a></li>
		</ul>
		<h3><a name="initialize">Initialization</a></h3>
		<div>
			COPE must be told, where to connect to the database.
			Within a servlet you probably
			want to do this in the <tt>init()</tt> method.
			The file <tt>cope.properties</tt> should be in the
			<tt>WEB-INF</tt> subdirectory to protect it against client access.
			So you will probably want to write something like this:
		</div>
<pre>
public void init() throws ServletException
{
   Main.model.setPropertiesInitially(
      new com.exedio.cope.Properties(
         new File(getServletContext().
           getRealPath("WEB-INF/cope.properties"))));
}
</pre>
		<div>
			For your convenience, there is a helper method,
			which does just that:
		</div>
<pre>
public void init() throws ServletException
{
   ServletUtil.initialize(Main.model, getServletContext());
}
</pre>
		<div>
			Even this can be ommitted, if you use the <i>TransactionFilter</i>
			explained below.
			Please note, that <tt>setPropertiesInitially</tt> is idempotent,
			it doesn't hurt to call it more than once,
			for example if you have more than one servlet.
		</div>
		<h3><a name="transactions">Transactions</a></h3>
		<div>
			From the <a href="transactions.html">Transaction Trail</a> you
			already know, how to use transactions with COPE.
			With a single servlet you may want to write something like this:
		</div>
<pre>
protected void doGet(
      HttpServletRequest request,
      HttpServletResponse response)
{
   try
   {
      Main.model.startTransaction();
      ...
      Main.model.commit();
   }
   finally
   {
      Main.model.rollbackIfNotCommitted();
   }
}
</pre>
		<div>
			However, this is not always feasible.
			Sometimes you just don't have a single servlet
			(or a small number of servlets)
			in your application.
			Even worse, the method <tt>doGet</tt> could be called reentrantly.
			This is very common when using the struts framework.
		</div>
		<div>
			A nice solution for both problems is delegating the transaction handling into a
			<a href="http://java.sun.com/j2ee/sdk_1.3/techdocs/api/javax/servlet/Filter.html">filter</a>.
			Class
			<a href="api/com/exedio/cope/util/TransactionFilter.html">TransactionFilter</a>
			provides such a filter.   
			It must be deployed in your <tt>web.xml</tt>:
		</div>
<pre>
&lt;filter&gt;
   &lt;filter-name&gt;TransactionFilter&lt;/filter-name&gt;
   &lt;filter-class&gt;<a href="api/com/exedio/cope/util/TransactionFilter.html">com.exedio.cope.util.TransactionFilter</a>&lt;/filter-class&gt;
   &lt;init-param&gt;
      &lt;param-name&gt;model&lt;/param-name&gt;
      &lt;param-value&gt;<i>com.exedio.demoshop.Main</i>#model&lt;/param-value&gt;
   &lt;/init-param&gt;
&lt;/filter&gt;
&lt;filter-mapping&gt;
   &lt;filter-name&gt;TransactionFilter&lt;/filter-name&gt;
   &lt;url-pattern&gt;*.do&lt;/url-pattern&gt;
   &lt;dispatcher&gt;REQUEST&lt;/dispatcher&gt;
&lt;/filter-mapping&gt;
</pre>
		<div>
			The example above applies the filter for all request to <tt>*.do</tt>,
			a typical setting for struts.
			It assumes, that the main class resides in package <tt>com.exedio.demoshop</tt>,
			please adapt this to your package.
		</div>
		<div>
			As a side effect, the <i>TransactionFilter</i> initializes the
			model in its own <tt>init()</tt>,
			so you don't have to care about it anymore.
		</div>
		<h3><a name="console">COPE Console</a></h3>
		<img src="console.png" width="406" height="241" border="0" align="right">
		<div>
			When you start up your web application,
			you have to create the database schema at least once.
			This is done by calling <tt>Main.model.createDatabase()</tt>.
			Instead of putting a button somewhere in a jsp of your application,
			you can use the <i>COPE Console</i>,
			which assists you in creating/dropping/migrating the database schema
			and more.
		</div>
		<div>
			On the right you see the relevant part of the <i>COPE Console</i>.
			The button <i>create</i> creates the database schema,
			the button <i>drop</i> drops it.
		</div>
		<div>
			To deploy the <i>COPE Console</i> in your application,
			put the file <tt>exedio-cope-console.jar</tt> into your
			<tt>WEB-INF/lib</tt> directory.
			Then you just mount another servlet within your <tt>web.xml</tt>:
		</div>
		<br clear="right">
<pre>
&lt;servlet&gt;
   &lt;servlet-name&gt;console&lt;/servlet-name&gt;
   &lt;servlet-class&gt;com.exedio.cope.console.ConsoleServlet&lt;/servlet-class&gt;
   &lt;init-param&gt;
      &lt;param-name&gt;model&lt;/param-name&gt;
      &lt;param-value&gt;<i>com.exedio.demoshop.Main</i>#model&lt;/param-value&gt;
   &lt;/init-param&gt;
&lt;/servlet&gt;
&lt;servlet-mapping&gt;
   &lt;servlet-name&gt;console&lt;/servlet-name&gt;
   &lt;url-pattern&gt;/console/*&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
</pre>
		<div>
			Note, that the trailing "/*" in the url-pattern is mandatory,
			otherwise the servlet cannot deliver it's resources
			(style sheet etc).
		</div>
		<h3><a name="copernica">Copernica</a></h3>
		<a href="copernica1.png">
			<img src="copernica1.w200.jpg" width="200" height="163" border="0" align="right">
		</a>
		<a href="copernica2.png">
			<img src="copernica2.w200.jpg" width="200" height="113" border="0" align="right" valign="bottom">
		</a>
		<div>
			<i>Copernica</i> is an experimental generic backoffice for COPE.
			It allows the user to query and manipulate the data stored
			in a COPE model.
		</div>
		<div>
			Although <i>Copernica</i> is still in a very early stage of development,
			it already allows access to the persistent data
			suitable for development and debugging.
		</div>
		<div>
			Deploying <i>Copernica</i> in your application
			is very similar to the <i>COPE console</i>.
			Put the file <tt>exedio-copernica.jar</tt> into your
			<tt>WEB-INF/lib</tt> directory
			and the following snippet into your <tt>web.xml</tt>:
		</div>
		<br clear="right">
<pre>
&lt;servlet&gt;
   &lt;servlet-name&gt;copernica&lt;/servlet-name&gt;
   &lt;servlet-class&gt;com.exedio.copernica.CopernicaServlet&lt;/servlet-class&gt;
   &lt;init-param&gt;
      &lt;param-name&gt;model&lt;/param-name&gt;
      &lt;param-value&gt;<i>com.exedio.demoshop.Main</i>#model&lt;/param-value&gt;
   &lt;/init-param&gt;
&lt;/servlet&gt;
&lt;servlet-mapping&gt;
   &lt;servlet-name&gt;copernica&lt;/servlet-name&gt;
   &lt;url-pattern&gt;/copernica/*&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
</pre>
		<h3><a name="further">Further Reading</a></h3>
		<div>
			This was the web application trail of the cope tour.
			You may now proceed to trails:
			<ul>
				<li>
					<a href="searching.html">Searching Trail</a>
					gives you an introduction into the searching capabilities of cope.
				</li>
				<li>
					<a href="attributes2.html">Field Reloaded Trail</a>
					covers all the more specific possibilities to store data with cope.
				</li>
				<li>
					<a href="schema.html">Schema Trail</a>
					shows you the schema evolution support of the <i>COPE Console</i>.
				</li>
			</ul>
		</div>
		<address>
			Copyright &copy; 2004-2006
			<a href="http://www.exedio.com/" target="_top">exedio</a>
			Gesellschaft f&uuml;r Softwareentwicklung mbH.
		</address>
	</body>
</html>
