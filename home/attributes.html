<html>
	<head>
		<link rel="stylesheet" href="cope.css">
	</head>
	<body>
		<a href="http://www.exedio.com/">
			<img src="exedio.png" class="exedio">
		</a>
		<h1><a href="index.html">COPE</a></h1>
		<div>Cope with Object Persistence</div>
		
		<h2>Attribute Trail</h2>
		<a href="http://sourceforge.net/">
			<img src="http://sourceforge.net/sflogo.php?group_id=152867&amp;type=1"
				class="sf" alt="SourceForge.net Logo" />
		</a>
		<div>
			While the <a href="intro.html">initial trail</a>
			covered string attributes  only,
			this trails visits all kinds of other attributes
			as well as the more special features of string attributes.
		</div>
		<h3>Common Primitives</h3>
		<div>
			COPE provides attributes for all commonly used java primitives
			as well as for <tt>String</tt> and <tt>java.util.Date</tt>.
			This looks like this.
		</div>
<pre>
class Customer extends Item
{
   static final StringAttribute email =
       new StringAttribute();
   static final DateAttribute registrationDate =
       new DateAttribute();
   static final LongAttribute loginCounter =
       new LongAttribute();
   static final IntegerAttribute subsequentLoginFailures =
       new IntegerAttribute();
   static final DoubleAttribute priceCoefficient =
       new DoubleAttribute();
}
</pre>
		<div>
			Run the instrumentor, and you get setters/getters for all
			the new attributes.
			Also the <i>default creation constructor</i>
			will have parameters for the initial values of these attributes.
		</div>
		<h3>Allowing Null</h3>
		<div>
			You may have noticed, that you cannot store null
			into any of the attributes.
			This is because attributes are <i>mandatory</i> by default.
			You can easily change this to <i>optional</i>.
		</div>
<pre>
static final LongAttribute loginCounter =
    new LongAttribute(<b>OPTIONAL</b>);
</pre>
		<div>
			When you run the instrumentor, you may notice 
			a few changes in the generated code.
			<ol>
				<li>
					The <i>default creation constructor</i> does not
					include a parameter for <tt>loginCounter</tt> anymore.
					This is because a value for <tt>loginCounter</tt> is not needed
					for constructing an instance of Customer anymore.
					If you still want to have <tt>loginCounter</tt> included into
					the <i>default creation constructor</i> add a
					<tt>@cope.initial</tt> tag to the attribute:
<pre>
/**
 * <b>@cope.initial</b>
 */
static final LongAttribute loginCounter =
    new LongAttribute(OPTIONAL);
</pre>
				</li>
				<li>
					The signature of the getter and setter for <tt>loginCounter</tt>
					changed.
					Before, it used the primitive type <tt>long</tt>
<pre>
<b>long</b> getLoginCounter() { ... }
void setLoginCounter(<b>long</b> loginCounter) { ... }
</pre>
					but now being optional it uses the wrapper class <tt>java.lang.Long</tt>.
<pre>
<b>Long</b> getLoginCounter() { ... }
void setLoginCounter(<b>Long</b> loginCounter) { ... }
</pre>
				</li>
			</ol>
				</li>
		</div>
		<h3>Default Values</h3>
		<div>
			What we did above with the login counter is probably not,
			what one would want in a real project.
			One would probably rather want to make it <i>mandatory</i>
			and initialize it to zero for any newly created customer.
			This can be specified by:
		</div>
<pre>
static final LongAttribute loginCounter =
    new LongAttribute()<b>.defaultTo(0)</b>;
</pre>
		<div>
			In the instrumented code the type for setter/getter
			changes back to primitives again,
			but the <i>default creation constructor</i> does also
			not have a parameter for <tt>loginCounter</tt>.
		</div>
		<div>
			If you want to make the current date the default value
			of any date attribute,
			then of course <tt>defaultTo(new Date())</tt> won't work.
			Use instead:
		</div>
<pre>
static final DateAttribute registrationDate =
    new DateAttribute()<b>.defaultToNow()</b>;
</pre>
		<h3>Unique Attributes</h3>
		<div>
			Probably you wouldn't want to have more than one customer
			for any given email address.
			Peace of cake:
		</div>
<pre>
static final StringAttribute email =
    new StringAttribute(<b>UNIQUE</b>);
</pre>
		<div>
			If you violate this unique constraint either via a
			creation constructor or via <tt>setEmail</tt>
			this will throw a <tt>UniqueViolationException</tt>.
		</div>
		<div>
			In the instrumented code you will find a new convenience method
		</div>
<pre>
static final Customer findbyEmail(String email);
</pre>
		<div>
			which does, what it's name suggests.
		</div>
		<div>
			For unique constraints across multiple attributes
			the notation is slightly different:
		</div>
<pre>
class MatrixElement
{
   static final IntegerAttribute x =
       new IntegerAttribute();
   static final IntegerAttribute y =
       new IntegerAttribute();
   static final UniqueConstraint xy =
       new UniqueConstraint(x, y);
}
</pre>
		<h3>Enum Attributes</h3>
		<div>
			A common pattern in persistent models are attributes,
			the can have a value out of a predefined set of values.
			For that purpose java provides enums since JDK 1.5.
			COPE allows you to store such enums in attributes
			just like any other primitive:
		</div>
<pre>
class Customer extends Item
{
   static enum Status
   {
      STANDARD,
      GOLD,
      PLATINUM,
   }

   static final EnumAttribute&lt;Status&gt; email =
       newEnumAttribute(Status.class);
}
</pre>
		<h3>Item Attributes</h3>
		<div>
			An item attributes stores a reference to another persistent item.
			It's the object oriented counter part of
			a foreign key constraint in relational databases.
		</div>
		<div>
			Here an example of a product referencing the product group it belongs to:
		</div>
<pre>
class ProductGroup extends Item
{
   static final StringAttribute name =
       new StringAttribute();
}
</pre>
<pre>
class Product extends Item
{
   static final ItemAttribute&lt;ProductGroup&gt; productGroup =
       newEnumAttribute(ProductGroup.class);
}
</pre>
		<div>
			As specified above, a product group cannot be deleted,
			if there are still products referencing this product group.
			This is because the default <i>delete policy</i>
			of an item attribute is <i>forbid</i>.
			Alternativly you may want to have all products of a product group to be deleted,
			if that product group is deleted.
			To achive this, change the <i>default policy</i> to <i>cascade</i>.
		</div>
<pre>
static final ItemAttribute&lt;ProductGroup&gt; productGroup =
    newEnumAttribute(ProductGroup.class, <b>CASCADE</b>);
</pre>
		<div>
			Yet another alternative is to set the item attribute to null
			on all products referencing the product group to be deleted.
			This is done by:
		</div>
<pre>
static final ItemAttribute&lt;ProductGroup&gt; productGroup =
    newEnumAttribute(<b>OPTIONAL</b>, ProductGroup.class, <b>NULLIFY</b>);
</pre>
		<div>
			Of course <i>nullify</i> makes no sense for a <i>mandatory</i> attribute,
			so I changed it to <i>optional</i>.
		</div>
		<h3>Further Reading</h3>
		<div>
			This was the attribute trail of the cope tour.
			You may now proceed to trails:
			<ul>
				<li>transactions</li>
				<li>searching</li>
				<li>cope within a web application</li>
				<li>media</li>
				<li>understanding patterns</li>
			</ul>
		</div>
	</body>
</html>
