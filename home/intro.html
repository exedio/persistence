<html>
	<head>
		<link rel="stylesheet" href="cope.css">
	</head>
	<body>
		<a href="http://www.exedio.com/">
			<img src="exedio.png" class="exedio">
		</a>
		<h1><a href="index.html">COPE</a></h1>
		<div>Cope with Object Persistence</div>
		
		<h2>Initial Trail</h2>
		<a href="http://sourceforge.net/">
			<img src="http://sourceforge.net/sflogo.php?group_id=152867&amp;type=1"
				class="sf" alt="SourceForge.net Logo" />
		</a>
		<div>
			This is the initial trail of the cope documentation trails.
			It gives you a step-by-step introduction into the persistence framework cope.
		</div>
		<div>
			If you already decided to use cope for a project,
			you may want to use the cope demoshop as a template.
			This way you can skip most of the steps described here.
			The demoshop is available under the
			<a href="http://www.opensource.org/licenses/mit-license.php">The&nbsp;MIT&nbsp;License</a>.
			<br>
			<a href="http://sourceforge.net/project/showfiles.php?group_id=152867">Download</a>
		</div>
		<h3>Your first item</h3>
		<div>
			Creating a new persistent class within COPE is
			as easy as creating any java class.
			Make sure, the class extends <tt>Item</tt>
		</div>
<pre>
import com.exedio.cope.Item;

class Customer extends Item
{
}
</pre>
		<div>
			Now a persistent class is'nt very useful
			without any persistent attributes,
			so we also create our first one.
			To do this we declare a static final constant
			of the type <tt>StringAttribute</tt>.
		</div>
<pre>
import com.exedio.cope.Item;
import com.exedio.cope.StringAttribute;

class Customer extends Item
{
   static final StringAttribute email = new StringAttribute(DEFAULT);
}
</pre>
		<div>
			Thats the way you declare persistent classes and fields.
			Now we have to setup the cope source code instrumentor.
		</div>
		<h3>setting up the instrumentor</h3>
		<div>
			The instrumentor inserts a few methods and constructors into your
			source code, so you don't have to write it on your own.
			Don't worry, your code and the code generated by the instrumentor
			will peacefully coexist.
		</div>
		<div>
			Get a copy of <tt>exedio-cope.jar</tt> and <tt>exedio-cope-instrument.jar</tt>
			and put it into the directory where you keep your third-party libraries.
			In the following we assume, this is <tt>lib</tt>.
		</div>
		<div>
			Next we have to include the code instrumentor into your build process.
			Here we explain this for a build process managed by
			<a href="http://ant.apache.org/">apache ant</a>.
			We assume, that there is already a target <tt>compile</tt> which compiles
			your projects sources including class <tt>Customer</tt> created above
			located in directory <tt>src</tt>.
			Put the following into your <tt>build.xml</tt>
<pre>
&lt;taskdef name="instrument"
         classname="com.exedio.cope.instrument.AntTask"&gt;
  &lt;classpath&gt;
    &lt;pathelement location="<i>lib/exedio-cope-instrument.jar</i>" /&gt;
  &lt;/classpath&gt;
&lt;/taskdef&gt;

&lt;target name="instrument"&gt;
  &lt;instrument verbose="false"&gt;
    &lt;fileset dir="<i>${basedir}/src</i>"&gt;
      &lt;include name="*.java" /&gt;
    &lt;/fileset&gt;
  &lt;/instrument&gt;
&lt;/target&gt;
</pre>
		<div>
			Parts in <tt><i>italics</i></tt> need to be adapted to your
			directory layout.
			Make target <tt>compile</tt> depend on target <tt>instrument</tt> and
			add <tt>lib/exedio-cope.jar</tt> to the classpath of the <tt>javac</tt> task.
		</div>
		<div>
			Now the instrumentor is ready to run.
			On the command line type <tt>ant instrument</tt>.
		</div>
		<h3>results of the instrumentor</h3>
		<div>
			After running the instrumentor,
			the class <tt>Customer</tt> contains a few more methods and constructors.
			Lets have a look, what these are useful for.
		</div>
		<div>
			The first one in the <i>default creation constructor</i>:
		</div>
<pre>
Customer(String email)
{
   this(new SetValue[]{Customer.email.map(email)});
}
</pre>
		<div>
			It creates a new customer and sets the initial value of the attribute
			<tt>email</tt> for that customer.
			Note, for brevity the code snippet above does not include
			javadoc comments generated by the instrumenter.
		</div>
		<div>
			Next one is the generic creation constructor:
		</div>
<pre>
Customer(SetValue[] setValues)
{
   super(setValue);
}
</pre>
		<div>
			It creates a new customer and sets the initial values for any set of attributes
			for that customer.
			This comes handy if there are more attributes in class Customer,
			since by default not all attributes are set by the <i>default creation constructor</i>.
		</div>
		<div>
			Next one is the <i>reactivation constructor</i>:
		</div>
<pre>
Customer(ReactivationConstructorDummy d, int pk)
{
   super(d, pk);
}
</pre>
		<div>
			All you need to know about this for now is,
			that COPE uses this constructor internally and you don't have to care about.
			This constructor is one of the few things cope has to demand for all persistent classes.
		</div>
		<div>
			Next are the <i>attribute getter</i>
			and <i>attribute setter</i> for the attribute <tt>email</tt>:
		</div>
<pre>
String getEmail()
{
   return email.get(this);
}

void setEmail(String email)
{
   Customer.email.set(this, email);
}
</pre>
		<div>
			These allow convenient read/write access to the values of the attribute,
			after the creation of the item.
		</div>
		<div>
			Last but not least there is the <i>type constant</i>:
		</div>
<pre>
static final Type TYPE = Type.newType(Customer.class);
</pre>
		<div>
			This is useful for all sorts of things,
			most prominently searching the database.
			We'll get there in detail later.
			For now just two examples:
			<ol>
				<li>
					Searching for all customers is as easy as
					<tt>Customer.TYPE.search(null)</tt>.
					The result of this is even a typed list <tt>List&lt;Customer&gt;</tt>
				</li>
				<li>
					Searching for customers with a certain email address is done by
					<tt>Customer.TYPE.search(Customer.email.equal("cope@exedio.com"))</tt>.
				</li>
			</ol>
		</div>
		<div>
			Next we will really store some persistent data.
		</div>
		<h3>Make it run</h3>
		<div>
			First we have to tell cope,
			which persistent types are to be maintained by the project.
			For now this will be type <tt>Customer</tt> only.
			So we write a new class <tt>Main</tt>:
		</div>
<pre>
class Main
{
   static final Model model = new Model(
         Customer.TYPE
      );
}
</pre>
		<div>
			Of course, if you already have some central kind of main class,
			you can use this instead of writing a new one.
			Just make sure, that all your persistent types show up in the list.
		</div>
		<div>
			Next we will setup the database connection to be used by cope.
			First put a jdbc driver
			(i.e. <tt>hsqldb.jar</tt> or <tt>mysql-connector-bin-3.1.12.jar</tt>)
			in your classpath.
		</div>
		<div>
			Then create a file <tt>cope.properties</tt> with the following
			contents for hsqldb:
		</div>
<pre>
database=hsqldb
database.url=jdbc:hsqldb:mem:copetest
database.user=sa
database.password=
</pre>
		<div>
			or alternativly for mysql:
		</div>
<pre>
database=mysql
database.url=jdbc:mysql://<i>localhost</i>/<i>copetest</i>
database.user=<i>user</i>
database.password=<i>password</i>
</pre>
		<div>
			Parts in <tt><i>italics</i></tt> need to be adapted to your database.
			For mysql make sure, that the database does exist (<tt>create database copetest</tt>)
			and is accessible for the user.
		</div>
		<div>
			Finally we can add a main method to class <tt>Main</tt>,
			that creates a customer in the database.
		</div>
<pre>
public static main(String[] args)
{
   model.setPropertiesInitially(
      new Properties(new File("cope.properties")));
   model.createDatabase();
   Customer c = new Customer("copetest@exedio.com");
   System.out.println("email:"+customer.getEmail());
   c.setEmail("copetest@exedio.com");
   System.out.println("email2:"+customer.getEmail());
}
</pre>
		<div>
			The call to <tt>createDatabase</tt> builds the schema of the database.
			For this example it issues an sql statement like
			<tt>create table Customer ( email varchar(100) )</tt>
			to the database.
			Note, that for mysql the main method work once only.
			On any subsequent calls <tt>createDatabase</tt> fails,
			because table <tt>Customer</tt> already exists.
			On hsqldb the method work multiple times,
			because the database is in-memory only.
		</div>
		<h3>Further Reading</h3>
		<div>
			This was the initial trail of the cope tour.
			You may now proceed to trails:
			<ul>
				<li><a href="attributes.html">Attribute Trail</a></li>
				<li>transactions</li>
				<li>searching</li>
				<li>cope within a web application</li>
				<li>media</li>
				<li>understanding patterns</li>
			</ul>
		</div>
	</body>
</html>
