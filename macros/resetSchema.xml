<?xml version="1.0"?>

<project name="resetSchema" default="drop" basedir="..">

	<target name="prepare">
		<!--suppress AntMissingPropertiesFileInspection -->
		<property file="${file}" />
		<echo message="resetting ${connection.url} ${connection.username} ${x-build.schema}" />
	</target>

	<target name="mysql" depends="prepare">
		<sql
				classpath="lib/${x-build.driver}"
				driver="com.mysql.cj.jdbc.Driver"
				url="${connection.url}"
				userid="${connection.username}"
				password="${connection.password}"
		>
			<!-- otherwise connect fails if database does not yet exist -->
			<connectionProperty name="createDatabaseIfNotExist" value="true" />
			<!-- see MysqlDialect#completeConnectionInfo -->
			<connectionProperty name="allowPublicKeyRetrieval" value="true" />
			<connectionProperty name="sslMode" value="DISABLED" />
			<connectionProperty name="serverTimezone" value="UTC" />
			<connectionProperty name="allowLoadLocalInfile" value="false" /><!-- MySQL driver -->
			<connectionProperty name="allowLocalInfile" value="false" /><!-- MariaDB driver -->
			SET @myschema = CONCAT("`", DATABASE(), "`");
			<!--
				* IF EXISTS not needed for DROP SCHEMA, because connection
					fails anyway if schema does not exist.
				* CHARACTER SET and COLLATE should have no effect for cope,
					but we still set it to be more deterministic.
			-->
			SET @stmtdrop   = CONCAT("DROP   SCHEMA ", @myschema);
			SET @stmtcreate = CONCAT("CREATE SCHEMA ", @myschema, "CHARACTER SET utf8 COLLATE utf8_general_ci");
			PREPARE stmt FROM @stmtdrop;
			EXECUTE stmt;
			PREPARE stmt FROM @stmtcreate;
			EXECUTE stmt;
		</sql>
	</target>

	<target name="postgresql" depends="prepare">
		<sql
				classpath="lib/${x-build.driver}"
				driver="org.postgresql.Driver"
				url="${connection.url}"
				userid="${connection.username}"
				password="${connection.password}"
		>
			DROP   SCHEMA IF EXISTS "${x-build.schema}" CASCADE;
			CREATE SCHEMA           "${x-build.schema}";
		</sql>
	</target>

</project>
