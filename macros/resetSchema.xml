<?xml version="1.0"?>

<project name="resetSchema" default="drop" basedir="..">

	<target name="prepare">
		<!--suppress AntMissingPropertiesFileInspection -->
		<property file="${file}" />
		<echo message="resetting ${connection.url} ${connection.username} ${x-build.schema}" />
	</target>

	<target name="mysql" depends="prepare">
		<sql
				classpath="lib/${x-build.driver}"
				driver="com.mysql.jdbc.Driver"
				url="${connection.url}"
				userid="${connection.username}"
				password="${connection.password}"
		>
			DROP   DATABASE IF EXISTS ${x-build.schema};
			CREATE DATABASE           ${x-build.schema};
		</sql>
	</target>

	<target name="oracle" depends="prepare">
		<get
				src="https://jenkins.exedio.com/job/ivyartifacts/lastSuccessfulBuild/artifact/repository/com.oracle/ojdbc6/11.2.0.4/ojdbc6-jar.jar"
				dest="lib/ojdbc.jar"
				maxtime="30" />
		<!-- BEWARE: the slash in the SQL below actually triggers execution - do not remove -->
		<sql
				classpath="lib/${x-build.driver}"
				driver="oracle.jdbc.OracleDriver"
				url="${connection.url}"
				userid="${connection.username}"
				password="${connection.password}"
				delimiter="/">
<![CDATA[
begin
	for r in (select table_name from user_tables) loop
		execute immediate 'drop table "'||r.table_name||'" cascade constraints purge';
	end loop;
end;
/
begin
	for r in (select object_name, object_type from user_objects where object_type not in ('PACKAGE BODY', 'TYPE BODY')) loop
		execute immediate 'drop '||r.object_type||' "'||r.object_name||'"';
	end loop;
end;
/
purge recyclebin
/
]]>
		</sql>
	</target>

	<target name="postgresql" depends="prepare">
		<sql
				classpath="lib/${x-build.driver}"
				driver="org.postgresql.Driver"
				url="${connection.url}"
				userid="${connection.username}"
				password="${connection.password}"
		>
			DROP   SCHEMA IF EXISTS ${x-build.schema} CASCADE;
			CREATE SCHEMA           ${x-build.schema};
		</sql>
	</target>

</project>
