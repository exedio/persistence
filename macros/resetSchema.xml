<?xml version="1.0"?>

<project name="resetSchema" default="drop" basedir="..">

	<target name="prepare">
		<!--suppress AntMissingPropertiesFileInspection -->
		<property file="${file}" />
		<echo message="resetting ${connection.url} ${connection.username} ${x-build.schema}" />
	</target>

	<target name="mysql" depends="prepare">
		<sql
				classpath="lib/${x-build.driver}"
				driver="com.mysql.cj.jdbc.Driver"
				url="${connection.url}"
				userid="${connection.username}"
				password="${connection.password}"
		>
			<!-- otherwise connect fails if database does not yet exist -->
			<connectionProperty name="createDatabaseIfNotExist" value="true" />
			<!-- see MysqlDialect#completeConnectionInfo -->
			<connectionProperty name="sslMode" value="DISABLED" />
			<connectionProperty name="serverTimezone" value="UTC" />
			<connectionProperty name="allowLoadLocalInfile" value="false" /><!-- MySQL driver -->
			<connectionProperty name="allowLocalInfile" value="false" /><!-- MariaDB driver -->
			SET @myschema = CONCAT("`", DATABASE(), "`");
			<!--
				* IF EXISTS not needed for DROP SCHEMA, because connection
					fails anyway if schema does not exist.
				* CHARACTER SET and COLLATE should have no effect for cope,
					but we still set it to be more deterministic.
			-->
			SET @stmtdrop   = CONCAT("DROP   SCHEMA ", @myschema);
			SET @stmtcreate = CONCAT("CREATE SCHEMA ", @myschema, "CHARACTER SET utf8 COLLATE utf8_general_ci");
			PREPARE stmt FROM @stmtdrop;
			EXECUTE stmt;
			PREPARE stmt FROM @stmtcreate;
			EXECUTE stmt;
		</sql>
	</target>

	<target name="oracle" depends="prepare">
		<get
				src="https://ivyartifacts.exedio.com/com.oracle/ojdbc6/11.2.0.4/ojdbc6-jar.jar"
				dest="lib/ojdbc.jar"
				maxtime="30" />
		<!-- BEWARE: the slash in the SQL below actually triggers execution - do not remove -->
		<sql
				classpath="lib/${x-build.driver}"
				driver="oracle.jdbc.OracleDriver"
				url="${connection.url}"
				userid="${connection.username}"
				password="${connection.password}"
				delimiter="/">
<![CDATA[
begin
	for r in (select table_name from user_tables) loop
		execute immediate 'drop table "'||r.table_name||'" cascade constraints purge';
	end loop;
end;
/
begin
	for r in (select object_name, object_type from user_objects where object_type not in ('PACKAGE BODY', 'TYPE BODY')) loop
		execute immediate 'drop '||r.object_type||' "'||r.object_name||'"';
	end loop;
end;
/
purge recyclebin
/
]]>
		</sql>
	</target>

	<target name="postgresql" depends="prepare">
		<sql
				classpath="lib/${x-build.driver}"
				driver="org.postgresql.Driver"
				url="${connection.url}"
				userid="${connection.username}"
				password="${connection.password}"
		>
			DROP   SCHEMA IF EXISTS "${x-build.schema}" CASCADE;
			CREATE SCHEMA           "${x-build.schema}";
		</sql>
	</target>

</project>
