<?xml version="1.0"?>

<project name="cope" default="build" basedir="."
			xmlns:if="ant:if"
			xmlns:unless="ant:unless">

	<condition property="jdk9"><available classname="java.lang.Runtime$Version" /></condition>
	<echo taskname="which ant" message="${ant.version}" />
	<echo taskname="which java" message="${java.vm.name} ${java.version}" />
	<echo taskname="which java" message="JDK >=9"       if:set="jdk9" />
	<echo taskname="which java" message="JDK ==1.8" unless:set="jdk9" />
	<!--suppress AntMissingPropertiesFileInspection -->
	<property file="local.properties" />
	<property file="project.properties" />
	<property environment="env"/>

	<import>
		<fileset dir="macros">
			<include name="*.xml" />
		</fileset>
	</import>

	<taskdef name="LoadFile" classname="org.apache.tools.ant.taskdefs.LoadFile" onerror="failall" />

	<taskdef
			resource="net/sf/antcontrib/antcontrib.properties"
			classpath="lib/ant-contrib.jar"
			onerror="failall" />
	<taskdef
			name="for"
			classname="net.sf.antcontrib.logic.ForTask"
			classpath="lib/ant-contrib.jar"
			onerror="failall" />

	<macrodef name="ljar">
		<attribute name="jarfile" />
		<attribute name="name" />
		<element name="implicit-element" optional="true" implicit="true" />
		<sequential>
			<!--echo message="local jar @{jarfile}" /-->
			<jar jarfile="@{jarfile}" filesonly="true" duplicate="fail" strict="fail" level="9">
				<implicit-element />
				<manifest>
					<attribute name="Specification-Title" value="exedio @{name}" />
					<attribute name="Specification-Version" value="${build.tag}" />
					<attribute name="Specification-Vendor" value="exedio GmbH" />
					<attribute name="Implementation-Title" value="exedio @{name}" />
					<attribute name="Implementation-Version" value="${build.tag}" />
					<attribute name="Implementation-Vendor" value="exedio GmbH" />
				</manifest>
			</jar>
			<plot file="@{jarfile}" />
		</sequential>
	</macrodef>

	<macrodef name="ljunit">
		<attribute name="scansrc" />
		<attribute name="testproperty" default="testproperty.default.XXX" />
		<attribute name="line" default="" />
		<attribute name="env" default="N" />
		<element name="implicit-element" optional="true" implicit="true" />
		<sequential>
			<mkdir dir="build/testresults" />
			<mkdir dir="build/testtmpdir" />
			<fail if:true="false">ant >= 1.9.1 required, see https://ant.apache.org/manual/ifunless.html</fail>
			<java taskname="junit" fork="yes" dir="${basedir}"
					failonerror="true"
					classname="org.junit.platform.console.ConsoleLauncher">
				<jvmarg value="-agentlib:jdwp=transport=dt_socket,server=y,address=${debug.address}" if:set="debug.address"/>
				<arg line="--details ${test-details}" />
				<arg line="--disable-ansi-colors" if:set="disable-ansi-colors" />
				<implicit-element />
				<arg line="--fail-if-no-tests" />
				<arg line="--include-classname .{0,}" unless:set="@{testproperty}" /> <!-- regexp ".*" doesn't work on Windows -->
				<arg line="--scan-class-path build/classes/@{scansrc}" unless:set="@{testproperty}" />
				<arg line="@{line}" unless:set="@{testproperty}" />
				<arg line="--select-class ${@{testproperty}}" if:set="@{testproperty}" unless:set="method" />
				<arg line="--select-method ${@{testproperty}}#${method}" if:set="method" />
				<arg line="--reports-dir build/testresults/@{scansrc}/@{env}" />
				<sysproperty key="java.io.tmpdir" value="${basedir}/build/testtmpdir" />
				<sysproperty key="user.timezone" value="${test-DefaultTimeZone}" />
				<sysproperty key="user.country"  value="${test-DefaultCountry}" />
				<sysproperty key="user.language" value="${test-DefaultLanguage}" />
				<sysproperty key="github" value="${github}" />
				<assertions><enable/></assertions>
			</java>
		</sequential>
	</macrodef>

	<macrodef name="runInTomcat">
		<attribute name="name" />
		<element name="body" optional="false" />
		<sequential>
			<trycatch>
				<try>
					<echo message="tomcat (@{name}): starting ..." />
					<condition property="catalina.executable" value="catalina.bat" else="catalina.sh">
						<os family="windows"/>
					</condition>
					<forget>
						<exec dir="${basedir}/tomcat/bin"
								executable="${basedir}/tomcat/bin/${catalina.executable}"
								failonerror="true"
								output="build/@{name}-catalina-start.log">
							<arg value="run" />
							<env key="CATALINA_OPTS" value="-enableassertions" />
						</exec>
					</forget>
					<echo message="tomcat (@{name}): waiting to be ready ..." />
					<waitfor
							maxwait="40" maxwaitunit="second"
							checkevery="5" checkeveryunit="second"
							timeoutproperty="server.app.init.failed">
						<http url="http://127.0.0.1:${tomcat.port.http}/cope-runtime-servlet/mediaConsole/" />
					</waitfor>
					<echo message="tomcat (@{name}): ready ..." />
					<fail if="server.app.init.failed" message="tomcat could not be started." />
					<body />
				</try>
				<finally>
					<echo message="tomcat (@{name}): stopping ..." />
					<exec dir="${basedir}/tomcat/bin"
							executable="${basedir}/tomcat/bin/${catalina.executable}"
							failonerror="true"
							output="build/@{name}-catalina-stop.log">
						<arg value="stop" />
					</exec>
					<echo message="tomcat (@{name}): waiting to be stopped ..." />
					<sleep seconds="10" />
					<echo message="tomcat (@{name}): stopped." />
				</finally>
			</trycatch>
		</sequential>
	</macrodef>

	<target name="sleepInTomcat" depends="tomcat" description="for inspecting tomcat manually">
		<runInTomcat name="sleepInTomcat">
			<body>
				<sleep seconds="60" />
			</body>
		</runInTomcat>
	</target>

	<target name="catalina">
		<property name="catalina.root" value="apache-tomcat-8.5.14" />
		<untar src="lib/tomcat.tar.gz"
				 compression="gzip"
				 dest="${basedir}">
			<patternset>
				<exclude name="${catalina.root}/conf/server.xml" />
				<exclude name="${catalina.root}/conf/tomcat-users.xml" />
				<exclude name="${catalina.root}/webapps/ROOT/**" />
				<exclude name="${catalina.root}/webapps/docs/**" />
				<exclude name="${catalina.root}/webapps/examples/**" />
			</patternset>
			<mapper type="glob" from="${catalina.root}/*" to="tomcat/*" />
		</untar>
		<chmod dir="tomcat/bin" perm="ugo+x" includes="*.sh" />
		<copy todir="tomcat/conf">
			<fileset dir="${basedir}/conf">
				<include name="tomcat-users.xml" />
			</fileset>
		</copy>
		<echo message="tomcat ports: shutdown=${tomcat.port.shutdown} http=${tomcat.port.http}" />
		<copy file="conf/server.xml" todir="tomcat/conf" overwrite="true">
			<filterset>
				<filter token="PORT_SHUTDOWN" value="${tomcat.port.shutdown}" />
				<filter token="PORT_HTTP"     value="${tomcat.port.http}"     />
			</filterset>
		</copy>
	</target>

	<!-- dsmf -->

	<target name="dsmf.compile">
		<compile srcdir="dsmf/src">
			<classpath>
				<pathelement location="lib/slf4j-api.jar" />
				<pathelement location="lib/jsr305.jar" />
			</classpath>
		</compile>
	</target>

	<target name="dsmf.clean">
		<delete dir="build/dsmf" />
	</target>

	<!-- runtime -->

	<target name="runtime.core.compile" depends="dsmf.compile, instrument.anno.compile">
		<compile srcdir="runtime/src">
			<classpath>
				<pathelement location="build/classes/dsmf/src" />
				<pathelement location="build/classes/instrument/annosrc" />
				<pathelement location="lib/trove4j.jar" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/slf4j-api.jar" />
				<pathelement location="lib/micrometer-core.jar" />
				<pathelement location="lib/jsr305.jar" />
				<pathelement location="lib/annotations.jar" />
			</classpath>
		</compile>
	</target>

	<target name="runtime.dialect.compile" depends="dsmf.compile, runtime.core.compile, instrument.anno.compile">
		<foreachDialect>
			<body>
				<echo message="Compiling dialect @{name} with @{jar}." />
				<compile srcdir="runtime/@{name}src">
					<classpath>
						<pathelement location="build/classes/dsmf/src" />
						<pathelement location="build/classes/runtime/src" />
						<pathelement location="build/classes/instrument/annosrc" />
						<pathelement location="lib/exedio-cope-util.jar" />
						<pathelement location="lib/trove4j.jar" />
						<pathelement location="lib/slf4j-api.jar" />
						<pathelement location="lib/jsr305.jar" />
						<pathelement location="lib/annotations.jar" />
						<pathelement location="lib/@{jar}" />
					</classpath>
				</compile>
				<copy todir="build/classes/runtime/dialects">
					<fileset dir="build/classes/runtime/@{name}src">
						<exclude name="META-INF/services/com.exedio.cope.DialectUrlMapper" />
					</fileset>
				</copy>
			</body>
		</foreachDialect>
		<delete file="build/classes/runtime/dialects/META-INF/services/com.exedio.cope.DialectUrlMapper" />
		<foreachDialect>
			<body>
				<echo message="Concatenating DialectUrlMapper for @{name}." />
				<concat  destfile="build/classes/runtime/dialects/META-INF/services/com.exedio.cope.DialectUrlMapper" append="true">
					<fileset file="build/classes/runtime/@{name}src/META-INF/services/com.exedio.cope.DialectUrlMapper" />
				</concat>
			</body>
		</foreachDialect>
	</target>

	<target name="runtime.pattern.compile" depends="runtime.core.compile, instrument.anno.compile">
		<compile srcdir="runtime/patternsrc">
			<classpath>
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/instrument/annosrc" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/slf4j-api.jar" />
				<pathelement location="lib/micrometer-core.jar" />
				<pathelement location="lib/jsr305.jar" />
				<pathelement location="lib/annotations.jar" />
			</classpath>
		</compile>
	</target>

	<target name="runtime.servlet.compile" depends="dsmf.compile, runtime.core.compile, runtime.pattern.compile, instrument.anno.compile">
		<compile srcdir="runtime/servletsrc">
			<classpath>
				<pathelement location="build/classes/dsmf/src" />
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/patternsrc" />
				<pathelement location="build/classes/instrument/annosrc" />
				<pathelement location="lib/javax.servlet-api.jar" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/slf4j-api.jar" />
				<pathelement location="lib/micrometer-core.jar" />
				<pathelement location="lib/jsr305.jar" />
				<pathelement location="lib/annotations.jar" />
			</classpath>
		</compile>
	</target>

	<target name="runtime.compile"
				depends="runtime.core.compile,
							runtime.pattern.compile,
							runtime.servlet.compile" />

	<target name="runtime.core.jar" depends="dsmf.compile, runtime.core.compile, runtime.dialect.compile, runtime.pattern.compile, runtime.servlet.compile, runtime.test.protocol">
		<ljar name="cope" jarfile="build/exedio-cope.jar">
			<fileset dir="build/classes/dsmf/src" />
			<fileset dir="build/classes/runtime/src" />
			<fileset dir="build/classes/runtime/patternsrc" />
			<fileset dir="build/classes/runtime/servletsrc" />
		</ljar>
	</target>

	<target name="runtime.dialect.jar" depends="runtime.dialect.compile">
		<foreachDialect>
			<body>
				<ljar name="cope dialect @{name}" jarfile="build/exedio-cope-@{name}.jar">
					<fileset dir="build/classes/runtime/@{name}src" />
				</ljar>
			</body>
		</foreachDialect>
	</target>

	<target name="runtime.jar" depends="runtime.core.jar, runtime.dialect.jar" />

	<target name="runtime.jar.src">
		<mkdir dir="build" />
		<zip destfile="build/exedio-cope-src.zip" filesonly="true" whenempty="fail" duplicate="fail" level="9">
			<zipfileset dir="${basedir}/dsmf/src"          ><include name="**/*.java"/></zipfileset>
			<zipfileset dir="${basedir}/runtime/src"       ><include name="**/*.java"/></zipfileset>
			<zipfileset dir="${basedir}/runtime/patternsrc"><include name="**/*.java"/></zipfileset>
			<zipfileset dir="${basedir}/runtime/servletsrc"><include name="**/*.java"/></zipfileset>
			<zipfileset dir="${basedir}/instrument/annosrc"><include name="**/*.java"/></zipfileset>
		</zip>
		<plot file="build/exedio-cope-src.zip" />
	</target>

	<target name="runtime.test.feature.compile"
			depends="runtime.core.compile, runtime.pattern.compile, runtime.servlet.compile, instrument.anno.compile">
		<compile srcdir="runtime/testfeaturesrc">
			<classpath>
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/patternsrc" />
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="build/classes/instrument/annosrc" />
				<pathelement location="lib/junit-jupiter-api.jar" />
				<pathelement location="lib/junit-platform-commons.jar" />
				<pathelement location="lib/opentest4j.jar" />
				<pathelement location="lib/apiguardian-api.jar" />
				<pathelement location="lib/javax.servlet-api.jar" />
				<pathelement location="lib/jsr305.jar" />
				<pathelement location="lib/annotations.jar" />
			</classpath>
		</compile>
	</target>

	<path id="runtime.test.path">
		<pathelement location="build/classes/dsmf/src" />
		<pathelement location="build/classes/runtime/src" />
		<pathelement location="build/classes/runtime/dialects" />
		<pathelement location="build/classes/runtime/patternsrc" />
		<pathelement location="build/classes/runtime/servletsrc" />
		<pathelement location="build/classes/runtime/testfeaturesrc" />
		<pathelement location="build/classes/instrument/annosrc" />
		<pathelement location="lib/trove4j.jar" />
		<pathelement location="lib/javax.servlet-api.jar" />
		<pathelement location="lib/junit-jupiter-api.jar" />
		<pathelement location="lib/junit-platform-commons.jar" />
		<pathelement location="lib/apiguardian-api.jar" />
		<pathelement location="lib/opentest4j.jar" />
		<pathelement location="lib/slf4j-api.jar" />
		<pathelement location="lib/log4j-bundle.jar" />
		<pathelement location="lib/micrometer-core.jar" />
		<pathelement location="lib/micrometer-registry-prometheus.jar" />
		<pathelement location="lib/simpleclient-bundle.jar" />
		<pathelement location="lib/simpleclient_common-bundle.jar" />
		<pathelement location="lib/exedio-cope-util.jar" />
		<pathelement location="lib/jsr305.jar" />
		<pathelement location="lib/annotations.jar" />
	</path>

	<target
			name="runtime.test.instrument"
			depends="instrument.taskdef,
					dsmf.compile, runtime.core.compile, runtime.dialect.compile, runtime.pattern.compile,
					runtime.servlet.compile, runtime.test.feature.compile,
					instrument.anno.compile"
			unless="skip.instrument">
		<instrument
				dir="runtime/testsrc"
				verify="${instrument.verify}"
				finalMethodInFinalClass="false"
				nullabilityAnnotations="${instrument.nullabilityAnnotations}"
				buildDirectory="build/instrument/runtime.test">
			<resources refid="instrument.resources" />
			<classpath refid="runtime.test.path"/>
			<generateDeprecated>com.exedio.cope.pattern.PasswordRecovery#redeem(com.exedio.cope.Item,long)</generateDeprecated>
			<suppressWarnings>
				<constructor>RedundantSuppression</constructor>
				<constructor>TypeParameterExtendsFinalClass</constructor>
				<constructor>UnnecessarilyQualifiedInnerClassAccess</constructor>
				<wrapper>RedundantSuppression</wrapper>
				<wrapper>TypeParameterExtendsFinalClass</wrapper>
				<wrapper>UnnecessarilyQualifiedStaticUsage</wrapper>
			</suppressWarnings>
			<ignore>
				<fileset file="runtime/testsrc/com/exedio/cope/vaulttest/VaultServiceTest.java" />
			</ignore>
		</instrument>
	</target>

	<target name="runtime.test.compile"
			depends="runtime.test.instrument, dsmf.compile, runtime.core.compile, runtime.pattern.compile, runtime.servlet.compile, runtime.test.feature.compile, instrument.anno.compile">
		<compile srcdir="runtime/testsrc">
			<classpath refid="runtime.test.path"/>
		</compile>
	</target>

	<target name="runtime.test.readyToRun" depends="dsmf.compile, runtime.core.compile, runtime.dialect.compile, runtime.pattern.compile, runtime.servlet.compile, runtime.test.feature.compile, runtime.test.compile" />

	<target name="runtime.test.withEnv.setup.mysql" if="runtime.test.withEnv.setup.mysql.url">
		<sql
				classpath="lib/mysql-connector-java.jar"
				driver="com.mysql.cj.jdbc.Driver"
				url="${runtime.test.withEnv.setup.mysql.url}"
				src="${runtime.test.withEnv.setup.mysql.sql}"
				userid="root"
				password="${runtime.test.withEnv.setup.password}"
		>
			<!-- see MysqlDialect#completeConnectionInfo -->
			<connectionProperty name="allowPublicKeyRetrieval" value="true" />
			<connectionProperty name="useSSL" value="false" />
			<connectionProperty name="serverTimezone" value="UTC" />
			<connectionProperty name="allowLoadLocalInfile" value="false" /><!-- MySQL driver -->
			<connectionProperty name="allowLocalInfile" value="false" /><!-- MariaDB driver -->
		</sql>
	</target>

	<target name="runtime.test.withEnv.setup.postgresql" if="runtime.test.withEnv.setup.postgresql.url">
		<sql
				classpath="lib/postgresql.jar"
				driver="org.postgresql.Driver"
				url="${runtime.test.withEnv.setup.postgresql.url}"
				src="conf/setup-postgresql-createDatabase.sql"
				userid="postgres"
				password="${runtime.test.withEnv.setup.password}"
				autocommit="true" />
		<sql
				classpath="lib/postgresql.jar"
				driver="org.postgresql.Driver"
				url="${runtime.test.withEnv.setup.postgresql.url}test_db_database"
				src="conf/setup-postgresql-useDatabase.sql"
				userid="postgres"
				password="${runtime.test.withEnv.setup.password}"
				autocommit="true" />
	</target>

	<target
			name="runtime.test.withEnv.setup"
			depends="runtime.test.withEnv.setup.mysql,runtime.test.withEnv.setup.postgresql" />

	<target name="runtime.test.withoutEnv" depends="runtime.test.readyToRun">
		<ljunit scansrc="runtime/testsrc" testproperty="runtime.test.withoutEnv"
				line="--exclude-tag TestWithEnvironment">
			<classpath>
				<pathelement location="build/classes/dsmf/src" />
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/dialects" />
				<pathelement location="build/classes/runtime/patternsrc" />
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="build/classes/runtime/testfeaturesrc" />
				<pathelement location="build/classes/runtime/testsrc" />
				<pathelement location=              "runtime/testresources" />
				<pathelement location="build/classes/instrument/annosrc" />
				<pathelement location="lib/trove4j.jar" />
				<pathelement location="lib/javax.servlet-api.jar" />
				<pathelement location="lib/hsqldb.jar" />
				<pathelement location="lib/junit-jupiter-api.jar" />
				<pathelement location="lib/junit-jupiter-engine.jar" />
				<pathelement location="lib/junit-platform-console.jar" />
				<pathelement location="lib/junit-platform-launcher.jar" />
				<pathelement location="lib/junit-platform-engine.jar" />
				<pathelement location="lib/junit-platform-commons.jar" />
				<pathelement location="lib/opentest4j.jar" />
				<pathelement location="lib/slf4j-api.jar" />
				<pathelement location="lib/slf4j-log4j12.jar" />
				<pathelement location="lib/log4j-bundle.jar" />
				<pathelement location="lib/micrometer-core.jar" />
				<pathelement location="lib/LatencyUtils.jar" />
				<pathelement location="lib/micrometer-registry-prometheus.jar" />
				<pathelement location="lib/simpleclient-bundle.jar" />
				<pathelement location="lib/simpleclient_common-bundle.jar" />
				<pathelement location="lib/exedio-cope-util.jar" />
			</classpath>
			<sysproperty key="com.exedio.cope.ClusterNetworkTest.multicast"   value="${runtime.test.ClusterNetworkTest.multicast}" />
			<sysproperty key="com.exedio.cope.ClusterNetworkTest.port.A"      value="${runtime.test.ClusterNetworkTest.port.A}"    />
			<sysproperty key="com.exedio.cope.ClusterNetworkTest.port.B"      value="${runtime.test.ClusterNetworkTest.port.B}"    />
			<sysproperty key="com.exedio.cope.ClusterNetworkTest.port.C"      value="${runtime.test.ClusterNetworkTest.port.C}"    />
			<sysproperty key="com.exedio.cope.vault.VaultHttpServiceTest.url" value="${runtime.test.VaultHttpServiceTest.url}"    />
			<sysproperty key="com.exedio.cope.vault.VaultHttpServiceTest.dir" value="${runtime.test.VaultHttpServiceTest.dir}"    />
		</ljunit>
	</target>

	<target name="runtime.test.withEnv" depends="runtime.test.readyToRun, runtime.test.withEnv.setup">
		<foreachEnvironment skipSwitch="runtime.test">
			<body>
				<ljunit scansrc="runtime/testsrc" testproperty="runtime.test.withEnv"
						line="--include-tag TestWithEnvironment --exclude-classname com.exedio.cope.CacheReadPoisoningBruteForceTest --exclude-classname com.exedio.cope.ProtocolWriter"
						env="@{env}">
					<classpath>
						<pathelement location="build/classes/dsmf/src" />
						<pathelement location="build/classes/runtime/src" />
						<pathelement location="build/classes/runtime/@{env.dialect}src" />
						<pathelement location="build/classes/runtime/patternsrc" />
						<pathelement location="build/classes/runtime/servletsrc" />
						<pathelement location="build/classes/runtime/testfeaturesrc" />
						<pathelement location="build/classes/runtime/testsrc" />
						<pathelement location="build/classes/instrument/annosrc" />
						<pathelement location="lib/trove4j.jar" />
						<pathelement location="lib/javax.servlet-api.jar" />
						<pathelement location="lib/@{env.driver}" />
						<pathelement location="lib/junit-jupiter-api.jar" />
						<pathelement location="lib/junit-jupiter-engine.jar" />
						<pathelement location="lib/junit-platform-console.jar" />
						<pathelement location="lib/junit-platform-launcher.jar" />
						<pathelement location="lib/junit-platform-engine.jar" />
						<pathelement location="lib/junit-platform-commons.jar" />
						<pathelement location="lib/opentest4j.jar" />
						<pathelement location="lib/slf4j-api.jar" />
						<pathelement location="lib/slf4j-log4j12.jar" />
						<pathelement location="lib/log4j-bundle.jar" />
						<pathelement location="lib/micrometer-core.jar" />
						<pathelement location="lib/LatencyUtils.jar" />
						<pathelement location="lib/micrometer-registry-prometheus.jar" />
						<pathelement location="lib/simpleclient-bundle.jar" />
						<pathelement location="lib/simpleclient_common-bundle.jar" />
						<pathelement location="lib/exedio-cope-util.jar" />
					</classpath>
					<sysproperty key="com.exedio.cope.properties" file="@{env.file}" />
					<sysproperty key="contextPath" value="/junitContextPath" />
				</ljunit>
			</body>
		</foreachEnvironment>
	</target>

	<target name="runtime.test" depends="runtime.test.withoutEnv, runtime.test.withEnv" />

	<target name="runtime.test.protocol" depends="dsmf.compile, runtime.core.compile, runtime.dialect.compile, runtime.test.compile, runtime.test.withEnv.setup">
		<delete file="build/classes/runtime/src/com/exedio/cope/testprotocol.properties" />
		<foreachEnvironment skipSwitch="runtime.test.protocol">
			<body>
				<ljunit scansrc="runtime/testsrc"
						line="--include-tag ProtocolWriter"
						env="@{env}-protocol">
					<classpath>
						<pathelement location="build/classes/dsmf/src" />
						<pathelement location="build/classes/runtime/src" />
						<pathelement location="build/classes/runtime/@{env.dialect}src" />
						<pathelement location="build/classes/runtime/patternsrc" />
						<pathelement location="build/classes/runtime/servletsrc" />
						<pathelement location="build/classes/runtime/testfeaturesrc" />
						<pathelement location="build/classes/runtime/testsrc" />
						<pathelement location="build/classes/instrument/annosrc" />
						<pathelement location="lib/trove4j.jar" />
						<pathelement location="lib/javax.servlet-api.jar" />
						<pathelement location="lib/@{env.driver}" />
						<pathelement location="lib/junit-jupiter-api.jar" />
						<pathelement location="lib/junit-jupiter-engine.jar" />
						<pathelement location="lib/junit-platform-console.jar" />
						<pathelement location="lib/junit-platform-launcher.jar" />
						<pathelement location="lib/junit-platform-engine.jar" />
						<pathelement location="lib/junit-platform-commons.jar" />
						<pathelement location="lib/opentest4j.jar" />
						<pathelement location="lib/slf4j-api.jar" />
						<pathelement location="lib/slf4j-log4j12.jar" />
						<pathelement location="lib/log4j-bundle.jar" />
						<pathelement location="lib/micrometer-core.jar" />
						<pathelement location="lib/LatencyUtils.jar" />
						<pathelement location="lib/micrometer-registry-prometheus.jar" />
						<pathelement location="lib/simpleclient-bundle.jar" />
						<pathelement location="lib/simpleclient_common-bundle.jar" />
						<pathelement location="lib/exedio-cope-util.jar" />
					</classpath>
					<sysproperty key="com.exedio.cope.properties" file="@{env.file}" />
					<sysproperty key="com.exedio.cope.testprotocol.file" file="build/classes/runtime/src/com/exedio/cope/testprotocol.properties" />
					<sysproperty key="com.exedio.cope.testprotocol.prefix" value="@{env}" />
					<sysproperty key="contextPath" value="/junitContextPath" />
				</ljunit>
			</body>
		</foreachEnvironment>
	</target>

	<target name="runtime.web"
			  depends="runtime.core.compile, runtime.dialect.compile, runtime.test.compile">
		<foreachEnvironment skipSwitch="runtime.web">
			<body>
				<mkdir dir="build/runtime/web-@{env}" />
				<copy todir="build/runtime/web-@{env}/WEB-INF/classes">
					<fileset dir="build/classes/dsmf/src" />
					<fileset dir="build/classes/runtime/src" />
					<fileset dir="build/classes/runtime/@{env.dialect}src" />
					<fileset dir="build/classes/runtime/patternsrc" />
					<fileset dir="build/classes/runtime/servletsrc" />
					<fileset dir="build/classes/runtime/testfeaturesrc" />
					<fileset dir="build/classes/runtime/testsrc" />
				</copy>
				<copy todir="build/runtime/web-@{env}/WEB-INF/lib">
					<fileset file="lib/trove4j.jar" />
					<fileset file="lib/slf4j-api.jar" />
					<fileset file="lib/micrometer-core.jar" />
					<fileset file="lib/LatencyUtils.jar" />
					<fileset file="lib/micrometer-registry-prometheus.jar" />
					<fileset file="lib/simpleclient-bundle.jar" />
					<fileset file="lib/simpleclient_common-bundle.jar" />
					<fileset file="lib/opentest4j.jar" />
					<fileset file="lib/exedio-cope-util.jar" />
					<fileset file="lib/exedio-cope-console.jar" />
					<fileset file="lib/exedio-cops.jar" />
					<fileset file="lib/@{env.driver}" />
				</copy>
				<copy tofile="build/runtime/web-@{env}/WEB-INF/cope.properties" file="@{env.file}" />
				<copy todir="build/runtime/web-@{env}/WEB-INF/"
						file="runtime/web.xml" />
				<touch file="build/runtime/web-@{env}/WEB-INF/web.xml" />
			</body>
		</foreachEnvironment>
	</target>

	<target name="runtime.tomcat" depends="runtime.web, catalina">
		<foreachEnvironment skipSwitch="runtime.tomcat">
			<body>
				<copy tofile="tomcat/conf/Catalina/localhost/copelibtest-@{env}.xml"
						file="runtime/context.xml">
					<filterset>
						<filter token="ENV" value="@{env}" />
					</filterset>
				</copy>
			</body>
		</foreachEnvironment>
	</target>

	<target name="runtime.servlet.test.instrument" depends="instrument.taskdef,runtime.servlet.compile" unless="skip.instrument">
		<instrument
				dir="runtime/servlettestsrc"
				verify="${instrument.verify}"
				finalMethodInFinalClass="false"
				nullabilityAnnotations="${instrument.nullabilityAnnotations}">
			<classpath>
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="lib/javax.servlet-api.jar" /><!-- required to instrument Media features-->
			</classpath>
			<resources refid="instrument.resources" />
			<suppressWarnings>
				<constructor>RedundantSuppression</constructor>
				<constructor>TypeParameterExtendsFinalClass</constructor>
				<constructor>UnnecessarilyQualifiedInnerClassAccess</constructor>
				<wrapper>RedundantSuppression</wrapper>
				<wrapper>TypeParameterExtendsFinalClass</wrapper>
				<wrapper>UnnecessarilyQualifiedStaticUsage</wrapper>
			</suppressWarnings>
		</instrument>
	</target>

	<target name="runtime.servlet.test.web"
			  depends="runtime.servlet.test.instrument, dsmf.compile, runtime.core.compile, runtime.dialect.compile, runtime.servlet.compile, runtime.pattern.compile, instrument.anno.compile">
		<compile srcdir="runtime/servlettestsrc">
			<classpath>
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/patternsrc" />
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="build/classes/instrument/annosrc" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/javax.servlet-api.jar" />
				<pathelement location="lib/jsr305.jar" />
				<pathelement location="lib/annotations.jar" />
			</classpath>
		</compile>
		<copy todir="runtime/servlettestweb/WEB-INF/classes">
			<fileset dir="build/classes/dsmf/src" />
			<fileset dir="build/classes/runtime/src" />
			<fileset dir="build/classes/runtime/dialects" />
			<fileset dir="build/classes/runtime/patternsrc" />
			<fileset dir="build/classes/runtime/servletsrc" />
			<fileset dir="build/classes/runtime/servlettestsrc" />
		</copy>
		<copy file ="runtime/servlettestweb/log4j.properties"
				todir="runtime/servlettestweb/WEB-INF/classes" />
		<copy todir="runtime/servlettestweb/WEB-INF/lib">
			<fileset file="lib/trove4j.jar" />
			<fileset file="lib/exedio-cope-util.jar" />
			<fileset file="lib/exedio-cope-console.jar" />
			<fileset file="lib/exedio-cops.jar" />
			<fileset file="lib/hsqldb.jar" />
			<fileset file="lib/slf4j-api.jar" />
			<fileset file="lib/slf4j-log4j12.jar" />
			<fileset file="lib/log4j-bundle.jar" />
			<fileset file="lib/micrometer-core.jar" />
			<fileset file="lib/LatencyUtils.jar" />
			<fileset file="lib/opentest4j.jar" />
		</copy>
	</target>

	<target name="runtime.servlet.test.tomcat" depends="runtime.servlet.test.web, catalina">
		<copy tofile="tomcat/conf/Catalina/localhost/cope-runtime-servlet.xml"
				file="runtime/servlet-context.xml" />
	</target>

	<target name="runtime.servlet.webtest.compile">
		<compile srcdir="runtime/servlettestwebsrc">
			<classpath>
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/junit-jupiter-api.jar" />
				<pathelement location="lib/apiguardian-api.jar" />
				<pathelement location="lib/jsr305.jar"/>
			</classpath>
		</compile>
	</target>

	<target name="runtime.servlet.webtest"
				depends="catalina,
							runtime.servlet.test.tomcat,
							runtime.servlet.webtest.compile">
		<runInTomcat name="runtime.servlet.webtest">
			<body>
				<ljunit scansrc="runtime/servlettestwebsrc">
					<classpath>
						<pathelement location="build/classes/runtime/servlettestwebsrc" />
						<pathelement location="lib/exedio-cope-util.jar" />
						<pathelement location="lib/junit-jupiter-api.jar" />
						<pathelement location="lib/junit-jupiter-engine.jar" />
						<pathelement location="lib/junit-platform-console.jar" />
						<pathelement location="lib/junit-platform-launcher.jar" />
						<pathelement location="lib/junit-platform-engine.jar" />
						<pathelement location="lib/junit-platform-commons.jar" />
						<pathelement location="lib/opentest4j.jar" />
					</classpath>
					<sysproperty key="tomcat.port.http" value="${tomcat.port.http}" />
				</ljunit>
			</body>
		</runInTomcat>
	</target>

	<target name="runtime.clean">
		<delete>
			<fileset dir="runtime/servletsrc"><!-- is not created anymore -->
				<include name="**/*_Jspm.java" />
			</fileset>
			<fileset dir="runtime/servlettestsrc"><!-- is not created anymore -->
				<include name="**/*_Jspm.java" />
			</fileset>
		</delete>
		<delete dir="build/runtime" />
		<delete dir="runtime/servlettestweb/WEB-INF/classes" />
		<delete dir="runtime/servlettestweb/WEB-INF/lib" />
	</target>

	<!-- instrument -->

	<target name="instrument.anno.compile">
		<compile srcdir="instrument/annosrc">
			<classpath>
				<pathelement location="lib/jsr305.jar"/>
			</classpath>
		</compile>
	</target>

	<target name="instrument.anno.jar" depends="instrument.anno.compile">
		<ljar name="cope instrumentor annotations" jarfile="build/exedio-cope-instrument-annotations.jar">
			<fileset dir="build/classes/instrument/annosrc" />
		</ljar>
	</target>

	<target name="instrument.completion.jar" depends="instrument.completion.compile">
		<ljar name="cope instrumentor completions" jarfile="build/exedio-cope-instrument-completion.jar">
			<fileset dir="build/classes/instrument/completionsrc" />
		</ljar>
	</target>

	<target name="instrument.core.compile" depends="runtime.core.compile, runtime.pattern.compile, instrument.anno.compile">
		<echo taskname="JAVA_HOME" message="${env.JAVA_HOME}" unless:set="jdk9" />
		<compile srcdir="instrument/src">
			<classpath>
				<pathelement location="${env.JAVA_HOME}/lib/tools.jar" unless:set="jdk9" />
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/patternsrc" /><!-- TODO stricter, is for Composite only -->
				<pathelement location="build/classes/instrument/annosrc" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/jsr305.jar" />
			</classpath>
			<compilerarg if:set="jdk9" value="--add-exports" />
			<compilerarg if:set="jdk9" value="jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED" />
		</compile>
	</target>

	<target name="instrument.ant.compile" depends="instrument.core.compile">
		<compile srcdir="instrument/antsrc" includeAntRuntime="true">
			<classpath>
				<pathelement location="build/classes/instrument/src" />
				<pathelement location="lib/jsr305.jar" />
			</classpath>
		</compile>
	</target>

	<target name="instrument.completion.compile" depends="instrument.anno.compile">
		<compile srcdir="instrument/completionsrc">
			<classpath>
				<pathelement location="build/classes/instrument/annosrc" />
			</classpath>
		</compile>
	</target>

	<target name="instrument.compile" depends="instrument.core.compile, instrument.ant.compile, instrument.completion.compile" />

	<target name="instrument.jar" depends="instrument.core.compile, instrument.ant.compile">
		<ljar name="cope instrumentor" jarfile="build/exedio-cope-instrument.jar">
			<fileset dir="build/classes/instrument/src" />
			<fileset dir="build/classes/instrument/antsrc" />
		</ljar>
	</target>

	<target name="instrument.testfeature.compile" depends="runtime.core.compile, runtime.pattern.compile, runtime.servlet.compile, instrument.compile">
		<compile srcdir="instrument/testfeaturesrc">
			<classpath>
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/patternsrc" />
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="build/classes/instrument/annosrc" />
				<pathelement location="build/classes/instrument/src" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/javax.servlet-api.jar" />
				<pathelement location="lib/jsr305.jar" />
				<pathelement location="lib/annotations.jar" />
			</classpath>
		</compile>
	</target>

	<target name="instrument.taskdef" depends="dsmf.compile, runtime.core.compile, runtime.pattern.compile, instrument.compile">
		<taskdef resource="com/exedio/cope/instrument/ant.properties">
			<classpath id="instrument.resources">
				<pathelement location="build/classes/dsmf/src" />
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/patternsrc" /><!-- TODO stricter, is for Composite and Block only -->
				<pathelement location="build/classes/instrument/annosrc" />
				<pathelement location="build/classes/instrument/src" />
				<pathelement location="build/classes/instrument/antsrc" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/trove4j.jar" />
				<pathelement location="lib/jsr305.jar" />
				<pathelement location="lib/slf4j-api.jar" />
				<pathelement location="lib/micrometer-core.jar" />
				<pathelement location="lib/LatencyUtils.jar" />
			</classpath>
		</taskdef>
		<mkdir dir="build/timestamps"/>
	</target>

	<target name="instrument.test.instrument" depends="instrument.test.srcinstrument,instrument.test.libinstrument"/>

	<target name="instrument.test.srcinstrument" depends="instrument.taskdef,instrument.test.libcompile,instrument.testfeature.compile" unless="skip.instrument">
		<instrument
				dir="instrument/testsrc"
				verify="${instrument.verify}"
				charset="ascii"
				maxwarns="20000"
				finalMethodInFinalClass="false"
				nullabilityAnnotations="${instrument.nullabilityAnnotations}"
				timestampFile="build/timestamps/instrument.testsrc.timestamp">
			<resources refid="instrument.resources" />
			<classpath>
				<pathelement location="build/classes/instrument/testfeaturesrc" />
				<pathelement location="build/classes/instrument/testlibsrc" />
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="lib/javax.servlet-api.jar" /><!-- required to instrument Media features-->
				<pathelement location="lib/junit-jupiter-api.jar" />
				<pathelement location="lib/apiguardian-api.jar" />
				<pathelement location="${env.JAVA_HOME}/lib/tools.jar" unless:set="jdk9" />
			</classpath>
			<ignore>
				<fileset file="instrument/testsrc/com/exedio/cope/instrument/testmodel/DontInstrument.java" />
			</ignore>
			<generateDeprecated>com.exedio.cope.instrument.testfeature.WrapDeprecationFeature#goneAlmost(com.exedio.cope.Item)</generateDeprecated>
			<disableWrap>com.exedio.cope.instrument.testfeature.WrapFeature#disabledInBuildXml([[I)</disableWrap>
			<disableWrap>com.exedio.cope.instrument.testfeature.WrapperParametersFeatureGeneric#disabledInBuildXml(com.exedio.cope.Item,java.lang.Number)</disableWrap>
			<suppressWarnings>
				<constructor>RedundantSuppression</constructor>
				<constructor>TypeParameterExtendsFinalClass</constructor>
				<constructor>UnnecessarilyQualifiedInnerClassAccess</constructor>
				<wrapper>RedundantSuppression</wrapper>
				<wrapper>TypeParameterExtendsFinalClass</wrapper>
				<wrapper>UnnecessarilyQualifiedStaticUsage</wrapper>
			</suppressWarnings>
		</instrument>
	</target>

	<target name="instrument.test.paramssrcinstrument" depends="instrument.taskdef" unless="skip.instrument">
		<instrument
				dir="instrument/testparamssrc"
				verify="${instrument.verify}"
				serialVersionUIDSuffix="none"
				directSetValueMap="true"
				useConstantForEmptySetValuesArray="false"
				activator="false"
				nullabilityAnnotations="${instrument.nullabilityAnnotations}">
			<resources refid="instrument.resources" />
			<suppressWarnings>
				<type>type-single</type>
				<constructor>constructor-first</constructor>
				<constructor>constructor-second</constructor>
				<wrapper>wrapper-single</wrapper>
			</suppressWarnings>
		</instrument>
	</target>

	<target name="instrument.test.libinstrument" depends="instrument.taskdef, instrument.testfeature.compile" unless="skip.instrument">
		<instrument
				dir="instrument/testlibsrc"
				verify="${instrument.verify}"
				charset="ascii"
				maxwarns="20000"
				serialVersionUIDSuffix="capital"
				finalMethodInFinalClass="false"
				nullabilityAnnotations="${instrument.nullabilityAnnotations}">
			<resources refid="instrument.resources" />
			<classpath>
				<pathelement location="build/classes/instrument/testfeaturesrc" />
			</classpath>
			<suppressWarnings>
				<constructor>RedundantSuppression</constructor>
				<constructor>TypeParameterExtendsFinalClass</constructor>
				<constructor>UnnecessarilyQualifiedInnerClassAccess</constructor>
				<wrapper>RedundantSuppression</wrapper>
				<wrapper>TypeParameterExtendsFinalClass</wrapper>
				<wrapper>UnnecessarilyQualifiedStaticUsage</wrapper>
			</suppressWarnings>
		</instrument>
	</target>

	<target name="instrument.test.libcompile" depends="instrument.test.libinstrument, runtime.core.compile, runtime.pattern.compile, runtime.servlet.compile, instrument.compile">
		<compile srcdir="instrument/testlibsrc">
			<classpath>
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/patternsrc" />
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="build/classes/instrument/annosrc" />
				<pathelement location="build/classes/instrument/src" />
				<pathelement location="build/classes/instrument/testfeaturesrc" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/jsr305.jar" />
			</classpath>
		</compile>
	</target>

	<target name="instrument.test.compile" depends="instrument.test.libcompile, instrument.testfeature.compile, instrument.test.srcinstrument">
		<compile srcdir="instrument/testsrc">
			<classpath>
				<pathelement location="${env.JAVA_HOME}/lib/tools.jar" unless:set="jdk9" />
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/patternsrc" />
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="build/classes/instrument/annosrc" />
				<pathelement location="build/classes/instrument/src" />
				<pathelement location="build/classes/instrument/testfeaturesrc" />
				<pathelement location="build/classes/instrument/testlibsrc" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/junit-jupiter-api.jar" />
				<pathelement location="lib/opentest4j.jar" />
				<pathelement location="lib/apiguardian-api.jar" />
				<pathelement location="lib/jsr305.jar" />
				<pathelement location="lib/annotations.jar" />
			</classpath>
		</compile>
	</target>

	<target name="instrument.testparams.compile" depends="instrument.test.paramssrcinstrument">
		<compile srcdir="instrument/testparamssrc">
			<classpath>
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/patternsrc" />
				<pathelement location="build/classes/instrument/annosrc" />
				<pathelement location="lib/jsr305.jar" />
			</classpath>
		</compile>
	</target>

	<target name="instrument.test"
				depends="runtime.compile, instrument.compile, instrument.test.compile, instrument.testparams.compile">
		<ljunit scansrc="instrument/testsrc" testproperty="instrument.test">
			<classpath>
				<pathelement location="${env.JAVA_HOME}/lib/tools.jar" unless:set="jdk9" />
				<pathelement location="build/classes/dsmf/src" />
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/patternsrc" />
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="build/classes/instrument/src" />
				<pathelement location="build/classes/instrument/annosrc" />
				<pathelement location="build/classes/instrument/testfeaturesrc" />
				<pathelement location="build/classes/instrument/testlibsrc" />
				<pathelement location="build/classes/instrument/testsrc" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/trove4j.jar" />
				<pathelement location="lib/javax.servlet-api.jar" />
				<pathelement location="lib/slf4j-api.jar" />
				<pathelement location="lib/micrometer-core.jar" />
				<pathelement location="lib/junit-jupiter-api.jar" />
				<pathelement location="lib/junit-jupiter-engine.jar" />
				<pathelement location="lib/junit-platform-console.jar" />
				<pathelement location="lib/junit-platform-launcher.jar" />
				<pathelement location="lib/junit-platform-engine.jar" />
				<pathelement location="lib/junit-platform-commons.jar" />
				<pathelement location="lib/opentest4j.jar" />
				<pathelement location="lib/jsr305.jar" />
			</classpath>
		</ljunit>
	</target>

	<target name="instrument.clean">
		<delete dir="build/instrument" />
	</target>

	<!-- common -->

	<target name="src" depends="index" description="creates all sources, so the IDE does not complain" />

	<target name="instrument" depends="
			runtime.servlet.test.instrument,
			instrument.test.instrument,
			instrument.test.paramssrcinstrument,
			runtime.test.instrument" />

	<target name="compile"
			  depends="dsmf.compile,
			  runtime.compile,
			  runtime.servlet.test.web,
			  runtime.test.compile,
			  runtime.servlet.test.web,
			  runtime.servlet.webtest.compile,
			  instrument.compile,
			  instrument.test.libcompile,
			  instrument.testfeature.compile,
			  instrument.test.compile,
			  instrument.testparams.compile" />

	<target name="jar" depends="runtime.jar, instrument.anno.jar, instrument.jar, instrument.completion.jar" />

	<target name="testWithEnv" depends="runtime.test.withEnv, testprotocol" />

	<target name="test" depends="runtime.test, instrument.test" />

	<target name="web" depends="runtime.web" />

	<target name="tomcat" depends="runtime.tomcat, runtime.servlet.test.tomcat" />

	<target name="webtest" depends="runtime.servlet.webtest" />

	<target name="index">
		<foreachEnvironment skipSwitch="index">
			<body>
				<mkdir dir="build/environments" />
				<copy file="conf/environment.html" tofile="build/environments/@{env}.html">
					<filterset>
						<filter token="HOST" value="http://localhost:${tomcat.port.http}/" />
						<filter token="ENV" value="@{env}" />
					</filterset>
				</copy>
			</body>
		</foreachEnvironment>
	</target>

	<target name="clean" depends="dsmf.clean, runtime.clean, instrument.clean">
		<delete dir="build" />
		<delete dir="tomcat" />
	</target>

	<target name="api">
		<api title="cope persistence">
			<src>
				<fileset dir="dsmf/src" includes="**/*.java" />
				<fileset dir="runtime/src" includes="**/*.java" />
				<fileset dir="runtime/patternsrc" includes="**/*.java" />
				<fileset dir="runtime/servletsrc" includes="**/*.java" />
				<fileset dir="instrument/annosrc" includes="**/*.java" />
				<fileset dir="instrument/src" includes="**/*.java" />
				<fileset dir="instrument/antsrc" includes="**/*.java" />
			</src>
			<myClasspath>
				<pathelement location="lib/trove4j.jar" />
				<pathelement location="${ant.core.lib}" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/javax.servlet-api.jar" />
				<pathelement location="lib/slf4j-api.jar" />
				<pathelement location="lib/micrometer-core.jar" />
				<pathelement location="lib/jsr305.jar" />
				<pathelement location="lib/annotations.jar" />
				<pathelement location="${env.JAVA_HOME}/lib/tools.jar" unless:set="jdk9" />
			</myClasspath>
		</api>
	</target>

	<target name="testprotocol" depends="runtime.test.protocol, runtime.core.compile">
		<mkdir dir="build/runtime" />
		<java classname="com.exedio.cope.console.EnvironmentCop" taskname="testprotocol"
				fork="yes" failonerror="yes">
			<classpath>
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="lib/trove4j.jar" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/exedio-cope-console.jar" />
				<pathelement location="lib/exedio-cops.jar" />
				<pathelement location="lib/javax.servlet-api.jar" />
				<pathelement location="lib/slf4j-api.jar" />
				<pathelement location="lib/micrometer-core.jar" />
				<pathelement location="lib/micrometer-registry-prometheus.jar" />
				<pathelement location="lib/simpleclient-bundle.jar" />
				<pathelement location="lib/simpleclient_common-bundle.jar" />
			</classpath>
			<arg value="build/runtime/testprotocol.html"/>
			<assertions><enable/></assertions>
		</java>
		<LoadFile srcFile="build/runtime/testprotocol.html" property="testprotocol.html" />
		<copy file="runtime/testprotocol-template.html"
				tofile="build/testprotocol.html"
				overwrite="true">
			<filterset>
				<filter token="BUILD_TAG" value="${build.tag}" />
				<filter token="TABLE" value="${testprotocol.html}" />
			</filterset>
		</copy>
		<copy file="runtime/testprotocol.css" todir="build" />
	</target>

	<target name="build"
			depends="compile, test, jar, testprotocol,
						tomcat, index,
						webtest" />


	<target name="all" depends="build, runtime.jar.src, api" />

	<target name="jenkins" depends="all">
		<copy todir="${basedir}/build/success">
			<fileset file="${basedir}/build/exedio-cope.jar" />
			<fileset file="${basedir}/build/exedio-cope-src.zip" />
			<fileset file="${basedir}/build/exedio-cope-instrument-annotations.jar" />
			<fileset file="${basedir}/build/exedio-cope-instrument.jar" />
			<fileset file="${basedir}/build/exedio-cope-instrument-completion.jar" />
			<fileset file="${basedir}/exedio-cope-log.txt" />
		</copy>
		<foreachDialect>
			<body>
				<copy todir="${basedir}/build/success">
					<fileset file="${basedir}/build/exedio-cope-@{name}.jar" />
				</copy>
			</body>
		</foreachDialect>
		<copy file="ivy/ivy.xml" todir="build/success" overwrite="true">
			<filterset>
				<filter token="BUILD_REVISION" value="${build.revision}" />
				<filter token="BUILD_STATUS"   value="${build.status}" />
			</filterset>
		</copy>
	</target>

	<target name="publishlocally" depends="jar, runtime.jar.src">
		<ant dir="ivy" target="publishlocally" />
		<if>
			<isset property="gradle.offline.repo.path" />
			<then>
				<fail message="gradle.offline.repo.path does not point to an existing directory: ${gradle.offline.repo.path}">
					<condition>
						<not>
							<available file="${gradle.offline.repo.path}" type="dir"/>
						</not>
					</condition>
				</fail>
				<echo>publishing version 999999999 to ${gradle.offline.repo.path}</echo>
				<property name="repo.dir" value="${gradle.offline.repo.path}/com/exedio/cope/999999999" />
				<mkdir dir="${repo.dir}" />
				<copy tofile="${repo.dir}/exedio-cope-999999999.jar" file="build/exedio-cope.jar" />
				<copy tofile="${repo.dir}/exedio-cope-hsqldb-999999999.jar" file="build/exedio-cope-hsqldb.jar" />
				<copy tofile="${repo.dir}/exedio-cope-mysql-999999999.jar" file="build/exedio-cope-mysql.jar" />
				<copy tofile="${repo.dir}/exedio-cope-instrument-999999999.jar" file="build/exedio-cope-instrument.jar" />
				<copy tofile="${repo.dir}/exedio-cope-instrument-annotations-999999999.jar" file="build/exedio-cope-instrument-annotations.jar" />
				<copy tofile="${repo.dir}/ivy-999999999.xml" file="build/ivy.xml" />
			</then>
		</if>
	</target>

	<target name="licenseheaders" description="Updates the license headers in the source files.">
		<loadfile property="javaheader" srcFile="conf/javaheader.txt"/>
		<replaceregexp match="(/\*.*\*/.*)??^package " flags="sm" replace="${javaheader}${line.separator}package ">
			<fileset dir=".">
				<include name="**/*.java" />
				<exclude name="instrument/src/com/exedio/cope/instrument/Context.java" />
				<exclude name="instrument/src/com/exedio/cope/instrument/Generics.java" />
				<exclude name="instrument/src/com/exedio/cope/instrument/JavaClass.java" />
				<exclude name="instrument/src/com/exedio/cope/instrument/JavaFeature.java" />
				<exclude name="instrument/src/com/exedio/cope/instrument/JavaField.java" />
				<exclude name="instrument/src/com/exedio/cope/instrument/JavaFile.java" />
				<exclude name="instrument/src/com/exedio/cope/instrument/Main.java" />
				<exclude name="instrument/src/com/exedio/cope/instrument/Tags.java" />
			</fileset>
		</replaceregexp>
	</target>

</project>
