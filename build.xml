<?xml version="1.0"?>

<project name="cope" default="build" basedir=".">

	<property file="local.properties" />
	<property file="project.properties" />
	
	<import file="macros/compile.xml" />
	
	<taskdef name="LoadFile" classname="org.apache.tools.ant.taskdefs.LoadFile" />

	<taskdef
			resource="net/sf/antcontrib/antcontrib.properties"
			classpath="lib/ant-contrib.jar" />

	<taskdef
			resource="com/exedio/jspm/ant.properties"
			classpath="lib/exedio-jspm.jar" />
	
	<macrodef name="ljar">
		<attribute name="jarfile" />
		<attribute name="name" />
		<attribute name="classpath" />
		<element name="fileset" optional="true" implicit="true" />
		<sequential>
			<!--echo message="local jar @{jarfile}" /-->
			<jar jarfile="@{jarfile}" filesonly="true" duplicate="fail" level="9">
				<fileset />
				<manifest>
					<attribute name="Specification-Title" value="exedio @{name}" />
					<attribute name="Specification-Version" value="${build.tag}" />
					<attribute name="Specification-Vendor" value="exedio GmbH" />
					<attribute name="Implementation-Title" value="exedio @{name}" />
					<attribute name="Implementation-Version" value="${build.tag}" />
					<attribute name="Implementation-Vendor" value="exedio GmbH" />
					<attribute name="Class-Path" value="@{classpath}" />
				</manifest>
			</jar>
		</sequential>
	</macrodef>
	
	<macrodef name="ljunit">
		<attribute name="test" />
		<attribute name="env" default="N" />
		<element name="classpath" optional="true" implicit="true" />
		<sequential>
			<mkdir dir="build/testresults" />
			<junit fork="yes"
					haltonerror="true" haltonfailure="true"
					showoutput="true" printsummary="true">
				<formatter type="brief" usefile="false" />
				<formatter type="xml" />
				<classpath />
				<test name="@{test}" todir="build/testresults" outfile="@{test}-@{env}" />
				<sysproperty key="tomcat.port.http" value="${tomcat.port.http}" />
				<assertions><enable/></assertions>
			</junit>
		</sequential>
	</macrodef>
	
	<macrodef name="foreachEnvironment">
		<attribute name="skipSwitch" />
		<element name="body" optional="false" />
		<sequential>
			<for param="env.file">
				<path>
					<fileset dir="${basedir}/test-properties" includes="*.properties" />
				</path>
				<sequential>
					<basename file="@{env.file}" property="@{env.file}.env" suffix=".properties" />
					<!-- this is a dummy loop to create the attribute @{env} -->
					<for param="env" list="${@{env.file}.env}">
						<sequential>
							<property file="@{env.file}" prefix="@{env.file}." />
							<!--echo message="Doing @{skipSwitch} for @{env} skip switch:${@{env.file}.x-build.skip.@{skipSwitch}}." /-->
							<if>
								<istrue value="${@{env.file}.x-build.skip.@{skipSwitch}}"/>
								<then>
									<echo level="warning" message="Skipped @{skipSwitch} for @{env}." />
								</then>
								<else>
									<echo level="info" message="Doing @{skipSwitch} for @{env}" />
									<!-- this is a dummy loop to create the attribute @{env.driver} -->
									<for param="env.driver" list="${@{env.file}.x-build.driver}">
										<sequential>
											<body />
										</sequential>
									</for>
								</else>
							</if>
						</sequential>
					</for>
				</sequential>
			</for>
		</sequential>
	</macrodef>
	
	<macrodef name="runInTomcat">
		<attribute name="name" />
		<element name="body" optional="false" />
		<sequential>
			<trycatch>
				<try>
					<echo message="tomcat (@{name}): starting ..." />
					<condition property="catalina.executable" value="catalina.bat" else="catalina.sh">
						<os family="windows"/>
					</condition>
					<forget>
						<exec dir="${basedir}/tomcat/bin"
								executable="${basedir}/tomcat/bin/${catalina.executable}"
								failonerror="true"
								output="build/@{name}-catalina-start.log">
							<arg value="run" />
							<env key="CATALINA_OPTS" value="-enableassertions -Dcom.exedio.cope.media.imagemagick=true -Dcom.exedio.cope.media.convertcommand=${com.exedio.cope.media.convertcommand}" />
						</exec>
					</forget>
					<echo message="tomcat (@{name}): waiting to be ready ..." />
					<waitfor
							maxwait="40" maxwaitunit="second"
							checkevery="5" checkeveryunit="second"
							timeoutproperty="server.app.init.failed">
						<http url="http://127.0.0.1:${tomcat.port.http}/copetest/console" />
					</waitfor>
					<echo message="tomcat (@{name}): ready ..." />
					<fail if="server.app.init.failed" message="tomcat could not be started." />
					<body />
				</try>
				<finally>
					<echo message="tomcat (@{name}): stopping ..." />
					<exec dir="${basedir}/tomcat/bin"
							executable="${basedir}/tomcat/bin/${catalina.executable}"
							failonerror="true"
							output="build/@{name}-catalina-stop.log">
						<arg value="stop" />
					</exec>
					<echo message="tomcat (@{name}): waiting to be stopped ..." />
					<sleep seconds="10" />
					<echo message="tomcat (@{name}): stopped." />
				</finally>
			</trycatch>
		</sequential>
	</macrodef>
	
	<target name="catalina">
		<property name="catalina.root" value="apache-tomcat-6.0.16" />
		<untar src="lib/apache-tomcat.tar.gz"
				 compression="gzip"
				 dest="${basedir}">
			<patternset>
				<exclude name="${catalina.root}/conf/server.xml" />
				<exclude name="${catalina.root}/conf/tomcat-users.xml" />
				<exclude name="${catalina.root}/webapps/ROOT/**" />
				<exclude name="${catalina.root}/webapps/docs/**" />
				<exclude name="${catalina.root}/webapps/examples/**" />
			</patternset>
			<mapper type="glob" from="${catalina.root}/*" to="tomcat/*" />
		</untar>
		<chmod dir="tomcat/bin" perm="ugo+x" includes="*.sh" />
		<copy todir="tomcat/conf">
			<fileset dir="${basedir}">
				<include name="tomcat-users.xml" />
			</fileset>
		</copy>
		<echo message="tomcat ports: shutdown=${tomcat.port.shutdown} http=${tomcat.port.http}" />
		<copy file="server.xml" todir="tomcat/conf" overwrite="true">
			<filterset>
				<filter token="PORT_SHUTDOWN" value="${tomcat.port.shutdown}" />
				<filter token="PORT_HTTP"     value="${tomcat.port.http}"     />
			</filterset>
		</copy>
	</target>
	
	<!-- dsmf -->
	
	<target name="dsmf.compile">
		<compile srcdir="dsmf/src" />
	</target>
	
	<target name="dsmf.test.compile" depends="dsmf.compile">
		<compile srcdir="dsmf/testsrc">
			<classpath>
				<pathelement location="build/classes/dsmf/src" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/junit.jar" />
			</classpath>
		</compile>
	</target>
	
	<target name="dsmf.test" depends="dsmf.test.compile">
		<foreachEnvironment skipSwitch="dsmf.test">
			<body>
				<ljunit test="com.exedio.dsmf.PackageTest" env="@{env}">
					<classpath>
						<pathelement location="build/classes/dsmf/src" />
						<pathelement location="build/classes/dsmf/testsrc" />
						<pathelement location="lib/jdbc/@{env.driver}" />
						<pathelement location="lib/junit.jar" />
						<pathelement location="lib/exedio-cope-util.jar" />
					</classpath>
					<sysproperty key="com.exedio.cope.properties" file="@{env.file}" />
				</ljunit>
			</body>
		</foreachEnvironment>
	</target>
	
	<target name="dsmf.clean">
		<delete dir="build/dsmf" />
	</target>
	
	<!-- runtime -->
	
	<target name="runtime.core.compile" depends="dsmf.compile">
		<compile srcdir="runtime/src">
			<classpath>
				<pathelement location="build/classes/dsmf/src" />
				<pathelement location="lib/trove.jar" />
				<pathelement location="lib/exedio-cope-util.jar" />
			</classpath>
		</compile>
	</target>
	
	<target name="runtime.dialect.compile" depends="dsmf.compile, runtime.core.compile">
		<for param="dialect.file">
			<path>
				<fileset dir="${basedir}" includes="*.dialect.properties" />
			</path>
			<sequential>
				<basename file="@{dialect.file}" property="@{dialect.file}.name" suffix=".dialect.properties" />
				<property file="@{dialect.file}" prefix="@{dialect.file}." />
				<echo message="Compiling dialect ${@{dialect.file}.name} with ${@{dialect.file}.jar}." />
				<!--echo message="file=@{dialect.file},dialect=${@{dialect.file}.name},jar=${@{dialect.file}.jar}." /-->
				<compile srcdir="runtime/${@{dialect.file}.name}src">
					<classpath>
						<pathelement location="build/classes/dsmf/src" />
						<pathelement location="build/classes/runtime/src" />
						<pathelement location="lib/exedio-cope-util.jar" />
						<pathelement location="lib/trove.jar" />
						<pathelement location="lib/jdbc/${@{dialect.file}.jar}" />
					</classpath>
				</compile>
				<copy todir="build/classes/runtime/dialects">
					<fileset dir="build/classes/runtime/${@{dialect.file}.name}src" />
				</copy>
			</sequential>
		</for>
	</target>

	<target name="runtime.pattern.compile" depends="runtime.core.compile">
		<compile srcdir="runtime/patternsrc">
			<classpath>
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="lib/exedio-cope-util.jar" />
			</classpath>
		</compile>
	</target>
	
	<target name="runtime.servlet.compile" depends="runtime.core.compile">
		<compile srcdir="runtime/servletsrc">
			<classpath>
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="lib/servlet-api.jar" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/exedio-cops.jar" />
			</classpath>
		</compile>
	</target>
	
	<target name="runtime.junit.compile" depends="runtime.core.compile">
		<compile srcdir="runtime/junitsrc">
			<classpath>
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/junit.jar" />
			</classpath>
		</compile>
	</target>
	
	<target name="runtime.compile"
				depends="runtime.core.compile,
							runtime.dialect.compile,
							runtime.pattern.compile,
							runtime.servlet.compile,
							runtime.junit.compile" />
	
	<target name="runtime.jar" depends="dsmf.compile, runtime.core.compile, runtime.dialect.compile, runtime.pattern.compile, runtime.servlet.compile, runtime.junit.compile, runtime.test.protocol">
		<ljar name="cope" jarfile="build/exedio-cope.jar" classpath="trove.jar exedio-cope-util.jar">
			<fileset dir="build/classes/dsmf/src" />
			<fileset dir="build/classes/runtime/src" />
			<fileset dir="build/classes/runtime/dialects" />
			<fileset dir="build/classes/runtime/patternsrc" />
			<fileset dir="build/classes/runtime/servletsrc" />
			<fileset dir="build/classes/runtime/junitsrc" />
		</ljar>
	</target>
	
	<target name="runtime.jar.src">
		<mkdir dir="build" />
		<zip destfile="build/exedio-cope.jar-src.zip" filesonly="true" whenempty="fail" duplicate="fail" level="9">
			<zipfileset dir="${basedir}/dsmf/src"          ><include name="**/*.java"/></zipfileset>
			<zipfileset dir="${basedir}/runtime/src"       ><include name="**/*.java"/></zipfileset>
			<zipfileset dir="${basedir}/runtime/patternsrc"><include name="**/*.java"/></zipfileset>
			<zipfileset dir="${basedir}/runtime/servletsrc"><include name="**/*.java"/><exclude name="**/*_Jspm.java" /></zipfileset>
			<zipfileset dir="${basedir}/runtime/junitsrc"  ><include name="**/*.java"/></zipfileset>
		</zip>
	</target>
	
	<target name="runtime.test.instrument" depends="instrument.taskdef" unless="skip.instrument">
		<instrument finalArgs="true" createDeprecated="true" verbose="false">
			<fileset dir="runtime/testsrc/com/exedio/cope">
				<include name="**/*.java" />
				<exclude name="AbstractRuntimeTest.java" /><!-- TODO remove -->
				<exclude name="SchemaTest.java" /><!-- TODO remove -->
				<exclude name="TypesBoundTest.java" /><!-- ok, shall not instrument test types -->
				<exclude name="TypesBoundComplexTest.java" /><!-- ok, shall not instrument test types -->
				<exclude name="TypesBoundAnnotationTest.java" /><!-- ok, shall not instrument test types -->
				<exclude name="TypesBoundErrorTest.java" /><!-- ok, shall not instrument test types -->
				<exclude name="TypeSetTest.java" /><!-- ok, shall not instrument test types -->
				<exclude name="TypeCompareTest.java" /><!-- ok, shall not instrument test types -->
				<exclude name="FeatureTest.java" /><!-- ok, shall not instrument test types -->
				<exclude name="ModelCharSetTest.java" /><!-- ok, shall not instrument test types -->
				<exclude name="RenamedSchemaPattern.java" /><!-- ok, shall not instrument test types -->
				<exclude name="RenamedPatternSchemaTest.java" /><!-- ok, shall not instrument test types -->
				<exclude name="EnumTest.java" /><!-- TODO remove -->
				<exclude name="InstanceOfTest.java" /><!-- TODO remove -->
				<exclude name="NameTest.java" /><!-- TODO remove -->
				<exclude name="FieldTest.java" /><!-- TODO remove -->
				<exclude name="TestAnnotation.java" /><!-- TODO remove -->
				<exclude name="TestAnnotation2.java" /><!-- TODO remove -->
				<exclude name="RevisionInfoTest.java" /><!-- TODO remove -->
				<exclude name="pattern/DynamicModelTest.java" /><!-- TODO remove -->
				<exclude name="pattern/CompositeErrorTest.java" /><!-- ok, shall not instrument test types -->
				<exclude name="pattern/PatternTestTypeItem.java" /><!-- ok, shall not instrument test types -->
				<exclude name="serialize/ModelSerializationTest.java" /><!-- ok, shall not instrument test types -->
			</fileset>
		</instrument>
	</target>
	
	<target name="runtime.test.compile"
			depends="runtime.test.instrument, dsmf.compile, runtime.core.compile, runtime.pattern.compile, runtime.servlet.compile, runtime.junit.compile">
		<compile srcdir="runtime/testsrc">
			<classpath>
				<pathelement location="build/classes/dsmf/src" />
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/patternsrc" />
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="build/classes/runtime/junitsrc" />
				<pathelement location="lib/trove.jar" />
				<pathelement location="lib/servlet-api.jar" />
				<pathelement location="lib/junit.jar" />
				<pathelement location="lib/exedio-cope-util.jar" />
			</classpath>
		</compile>
	</target>
	
	<target name="runtime.test.jar" depends="dsmf.test.compile, runtime.test.compile">
		<ljar name="cope test" jarfile="build/exedio-cope-test.jar" classpath="exedio-cope.jar junit.jar">
			<fileset dir="build/classes/dsmf/testsrc" />
			<fileset dir="build/classes/runtime/testsrc" />
		</ljar>
	</target>
	
	<target name="runtime.test" depends="dsmf.compile, runtime.core.compile, runtime.dialect.compile, runtime.pattern.compile, runtime.servlet.compile, runtime.junit.compile, runtime.test.compile">
		<mkdir dir="build/testresults" />
		<foreachEnvironment skipSwitch="runtime.test">
			<body>
				<junit taskname="junit @{env}" fork="yes"
						 haltonerror="true" haltonfailure="true"
						 dir="${basedir}"
						 showoutput="true" printsummary="true">
					<formatter type="brief" usefile="false" />
					<formatter type="xml" />
					<classpath>
						<pathelement location="build/classes/dsmf/src" />
						<pathelement location="build/classes/runtime/src" />
						<pathelement location="build/classes/runtime/dialects" />
						<pathelement location="build/classes/runtime/patternsrc" />
						<pathelement location="build/classes/runtime/servletsrc" />
						<pathelement location="build/classes/runtime/junitsrc" />
						<pathelement location="build/classes/runtime/testsrc" />
						<pathelement location="lib/trove.jar" />
						<pathelement location="lib/servlet-api.jar" />
						<pathelement location="lib/jdbc/@{env.driver}" />
						<pathelement location="lib/junit.jar" />
						<pathelement location="lib/exedio-cope-util.jar" />
					</classpath>
					<test name="com.exedio.cope.PackageTest" todir="build/testresults" outfile="runtime-@{env}" />
					<sysproperty key="com.exedio.cope.properties" file="@{env.file}" />
					<sysproperty key="webapp" value="junitwebapp" />
					<assertions><enable/></assertions>
				</junit>
			</body>
		</foreachEnvironment>
	</target>
	
	<target name="runtime.test.protocol" depends="dsmf.compile, runtime.core.compile, runtime.dialect.compile, runtime.junit.compile, runtime.test.compile">
		<delete file="build/classes/runtime/src/com/exedio/cope/testprotocol.properties" />
		<foreachEnvironment skipSwitch="runtime.test.protocol">
			<body>
				<junit taskname="junit @{env}" fork="yes"
						 haltonerror="true" haltonfailure="true"
						 dir="${basedir}"
						 showoutput="true" printsummary="true">
					<formatter type="brief" usefile="false" />
					<classpath>
						<pathelement location="build/classes/dsmf/src" />
						<pathelement location="build/classes/runtime/src" />
						<pathelement location="build/classes/runtime/dialects" />
						<pathelement location="build/classes/runtime/junitsrc" />
						<pathelement location="build/classes/runtime/testsrc" />
						<pathelement location="lib/trove.jar" />
						<pathelement location="lib/jdbc/@{env.driver}" />
						<pathelement location="lib/junit.jar" />
						<pathelement location="lib/exedio-cope-util.jar" />
					</classpath>
					<test name="com.exedio.cope.ProtocolWriter" />
					<sysproperty key="com.exedio.cope.properties" file="@{env.file}" />
					<sysproperty key="com.exedio.cope.testprotocol.file" file="build/classes/runtime/src/com/exedio/cope/testprotocol.properties" />
					<sysproperty key="com.exedio.cope.testprotocol.prefix" value="@{env}" />
					<sysproperty key="webapp" value="junitwebapp" />
					<assertions><enable/></assertions>
				</junit>
			</body>
		</foreachEnvironment>
	</target>
	
	<target name="runtime.test.teardown" depends="runtime.compile, runtime.test.compile">
		<foreachEnvironment skipSwitch="runtime.teardown">
			<body>
				<java classname="com.exedio.cope.PackageTest" taskname="tear down @{env}"
						fork="yes" failonerror="yes">
					<classpath>
						<pathelement location="build/runtime/classes" />
						<pathelement location="build/runtime/testclasses" />
						<pathelement location="lib/trove.jar" />
						<pathelement location="lib/servlet-api.jar" />
						<pathelement location="lib/junit.jar" />
						<pathelement location="lib/jdbc/@{env.driver}" />
						<pathelement location="lib/exedio-cope-util.jar" />
					</classpath>
					<sysproperty key="com.exedio.cope.properties" file="@{env.file}" />
					<sysproperty key="webapp" value="teardownwebapp" />
					<assertions><enable/></assertions>
				</java>
			</body>
		</foreachEnvironment>
	</target>

	<target name="runtime.web"
			  depends="runtime.core.compile, runtime.test.compile,
							console.core.compile">
		<foreachEnvironment skipSwitch="runtime.web">
			<body>
				<mkdir dir="build/runtime/web-@{env}" />
				<copy todir="build/runtime/web-@{env}/WEB-INF/classes">
					<fileset dir="build/classes/runtime/src" />
					<fileset dir="build/classes/runtime/testsrc" />
					<fileset dir="build/classes/console/src" />
				</copy>
				<copy todir="build/runtime/web-@{env}/WEB-INF/lib">
					<fileset file="lib/trove.jar" />
					<fileset file="lib/exedio-cops.jar" />
					<fileset file="lib/exedio-cope-util.jar" />
					<fileset file="lib/jdbc/@{env.driver}" />
					<fileset file="lib/junit.jar" />
				</copy>
				<copy tofile="build/runtime/web-@{env}/WEB-INF/cope.properties" file="@{env.file}" />
				<copy todir="build/runtime/web-@{env}/WEB-INF/"
						file="runtime/web.xml" />
				<touch file="build/runtime/web-@{env}/WEB-INF/web.xml" />
			</body>
		</foreachEnvironment>
	</target>
	
	<target name="runtime.tomcat" depends="runtime.web, catalina">
		<foreachEnvironment skipSwitch="runtime.tomcat">
			<body>
				<copy tofile="tomcat/conf/Catalina/localhost/copelibtest-@{env}.xml"
						file="runtime/context.xml">
					<filterset>
						<filter token="ENV" value="@{env}" />
					</filterset>
				</copy>
			</body>
		</foreachEnvironment>
	</target>
	
	<target name="runtime.servlet.test.instrument" depends="instrument.taskdef" unless="skip.instrument">
		<instrument verbose="false">
			<fileset dir="runtime/servlettestsrc">
				<include name="**/*.java" />
				<exclude name="com/exedio/cope/pattern/MediaPattern.java" />
			</fileset>
		</instrument>
	</target>

	<target name="runtime.servlet.test.web"
			  depends="runtime.servlet.test.instrument, dsmf.compile, runtime.core.compile, runtime.dialect.compile, runtime.servlet.compile,
			           console.compile">
		<compile srcdir="runtime/servlettestsrc">
			<classpath>
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/servlet-api.jar" />
			</classpath>
		</compile>
		<copy todir="runtime/servlettestweb/WEB-INF/classes">
			<fileset dir="build/classes/dsmf/src" />
			<fileset dir="build/classes/runtime/src" />
			<fileset dir="build/classes/runtime/dialects" />
			<fileset dir="build/classes/runtime/servletsrc" />
		</copy>
		<copy todir="runtime/servlettestweb/WEB-INF/classes">
			<fileset dir="build/classes/console/src" />
		</copy>
		<copy todir="runtime/servlettestweb/WEB-INF/classes">
			<fileset dir="build/classes/runtime/servlettestsrc" />
		</copy>
		<copy todir="runtime/servlettestweb/WEB-INF/lib">
			<fileset file="lib/trove.jar" />
			<fileset file="lib/exedio-cope-util.jar" />
			<fileset file="lib/exedio-cops.jar" />
			<fileset file="lib/commons-fileupload.jar" />
			<fileset file="lib/commons-io.jar" />
			<fileset file="lib/jdbc/hsqldb.jar" />
		</copy>
	</target>
	
	<target name="runtime.servlet.test.tomcat" depends="runtime.servlet.test.web, catalina">
		<copy tofile="tomcat/conf/Catalina/localhost/cope-runtime-servlet.xml"
				file="runtime/servlet-context.xml" />
	</target>
	
	<target name="copernica.test.jspm">
		<jspm method="print">
			<fileset dir="copernica/testsrc" includes="**/*.jspm" />
		</jspm>
	</target>
	
	<target name="copernica.test.compile"
				depends="dsmf.compile, runtime.core.compile, runtime.servlet.compile, runtime.test.compile, copernica.test.jspm">
		<compile srcdir="copernica/testsrc">
			<classpath>
				<pathelement location="build/classes/dsmf/src" />
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="build/classes/runtime/testsrc" />
				<pathelement location="lib/exedio-cops.jar" />
				<pathelement location="lib/junit.jar" />
				<pathelement location="lib/servlet-api.jar" />
			</classpath>
		</compile>
		<copy todir="build/classes/copernica/testsrc/com/exedio/copernica/test">
			<fileset dir="copernica/testresources" /><!-- TODO use copy of macro compile -->
		</copy>
	</target>
	
	<target name="copernica.web" depends="copernica.test.compile, dsmf.compile, runtime.core.compile, runtime.dialect.compile, runtime.servlet.compile, runtime.test.compile, console.core.compile">
		<mkdir dir="build/copernica/web" />
		<copy todir="build/copernica/web/WEB-INF/classes">
			<fileset dir="build/classes/dsmf/src" />
			<fileset dir="build/classes/runtime/src" />
			<fileset dir="build/classes/runtime/dialects" />
			<fileset dir="build/classes/runtime/servletsrc" />
			<fileset dir="build/classes/runtime/testsrc" />
			<fileset dir="build/classes/console/src" />
			<fileset dir="build/classes/copernica/testsrc" />
		</copy>
		<copy todir="build/copernica/web/WEB-INF/lib">
			<fileset file="lib/trove.jar" />
			<fileset file="lib/commons-fileupload.jar" />
			<fileset file="lib/commons-io.jar" />
			<fileset file="lib/exedio-cops.jar" />
			<fileset file="lib/exedio-cope-util.jar" />
			<fileset file="lib/jdbc/hsqldb.jar" />
		</copy>
		<copy tofile="build/copernica/web/WEB-INF/cope.properties" file="test-properties/hsqldb.properties" />
		<copy todir="build/copernica/web/WEB-INF/"
				file="copernica/web.xml" />
		<touch file="build/copernica/web/WEB-INF/web.xml" />
	</target>
	
	<target name="copernica.tomcat" depends="copernica.web, catalina">
		<copy tofile="tomcat/conf/Catalina/localhost/copetest.xml"
				file="copernica/context.xml" />
	</target>
	
	<target name="copernica.webtest.compile">
		<compile srcdir="copernica/webtestsrc">
			<classpath>
				<pathelement location="lib/junit.jar" />
			</classpath>
		</compile>
	</target>
	
	<target name="copernica.webtest"
				depends="catalina,
							runtime.servlet.test.tomcat,
							copernica.tomcat, copernica.webtest.compile">
		<runInTomcat name="copernica.webtest">
			<body>
				<ljunit test="com.exedio.copernica.PackageTest">
					<classpath>
						<pathelement location="build/classes/copernica/webtestsrc" />
						<pathelement location="lib/junit.jar" />
					</classpath>
				</ljunit>
			</body>
		</runInTomcat>
	</target>

	<target name="copernica.clean">
		<delete dir="build/copernica" />
		<delete>
			<fileset dir="copernica/testsrc">
				<include name="**/*_Jspm.java" />
			</fileset>
		</delete>
	</target>
	
	<target name="runtime.clean">
		<delete>
			<fileset dir="runtime/servletsrc"><!-- is not created anymore -->
				<include name="**/*_Jspm.java" />
			</fileset>
			<fileset dir="runtime/servlettestsrc"><!-- is not created anymore -->
				<include name="**/*_Jspm.java" />
			</fileset>
		</delete>
		<delete dir="build/runtime" />
		<delete dir="runtime/servlettestweb/WEB-INF/classes" />
		<delete dir="runtime/servlettestweb/WEB-INF/lib" />
	</target>
	
	<!-- instrument -->
	
	<target name="instrument.core.compile" depends="runtime.core.compile, runtime.pattern.compile">
		<compile srcdir="instrument/src">
			<classpath>
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/patternsrc" /><!-- TODO stricter, is for Composite and Hash only -->
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/bsh-core.jar" />
				<pathelement location="lib/cojen.jar" />
			</classpath>
		</compile>
	</target>
	
	<target name="instrument.ant.compile" depends="instrument.core.compile">
		<compile srcdir="instrument/antsrc" includeAntRuntime="true">
			<classpath>
				<pathelement location="build/classes/instrument/src" />
				<pathelement location="lib/bsh-core.jar" />
			</classpath>
		</compile>
	</target>
	
	<target name="instrument.compile" depends="instrument.core.compile, instrument.ant.compile" />

	<target name="instrument.jar" depends="instrument.core.compile, instrument.ant.compile">
		<ljar name="cope instrumentor" jarfile="build/exedio-cope-instrument.jar" classpath="exedio-cope.jar bsh-core.jar cojen.jar">
			<fileset dir="build/classes/instrument/src" />
			<fileset dir="build/classes/instrument/antsrc" />
		</ljar>
	</target>
	
	<target name="instrument.taskdef" depends="runtime.core.compile, runtime.pattern.compile, runtime.servlet.compile, instrument.compile">
		<taskdef resource="com/exedio/cope/instrument/ant.properties">
			<classpath>
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/patternsrc" /><!-- TODO stricter, is for Composite and Hash only -->
				<pathelement location="build/classes/runtime/servletsrc" /><!-- just that instrumentor knows Media, no static dependency -->
				<pathelement location="build/classes/instrument/src" />
				<pathelement location="build/classes/instrument/antsrc" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/trove.jar" />
				<pathelement location="lib/servlet-api.jar" />
				<pathelement location="lib/bsh-core.jar" />
				<pathelement location="lib/cojen.jar" />
				<pathelement location="lib/junit.jar" />
			</classpath>
		</taskdef>
	</target>
	
	<target name="instrument.test.instrument" depends="instrument.taskdef" unless="skip.instrument">
		<instrument finalArgs="true" createDeprecated="true" verbose="false">
			<fileset dir="instrument/testsrc/com/exedio/cope/instrument/testmodel">
				<include name="**/*.java" />
			</fileset>
		</instrument>
	</target>
	
	<target name="instrument.test.compile" depends="instrument.test.instrument, runtime.core.compile, runtime.pattern.compile, runtime.servlet.compile, instrument.compile">
		<compile srcdir="instrument/testsrc">
			<classpath>
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/patternsrc" />
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="build/classes/instrument/src" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/junit.jar" />
			</classpath>
		</compile>
		<copy todir="build/classes/instrument/testsrc">
			<fileset dir="instrument/examplesrc">
				<include name="**/*.java" />
			</fileset>
		</copy>
	</target>
	
	<target name="instrument.test"
				depends="runtime.compile, instrument.compile, instrument.test.compile">
		<ljunit test="com.exedio.cope.instrument.PackageTest">
			<classpath>
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/patternsrc" />
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="build/classes/instrument/src" />
				<pathelement location="build/classes/instrument/testsrc" />
				<pathelement location="lib/trove.jar" />
				<pathelement location="lib/servlet-api.jar" />
				<pathelement location="lib/bsh-core.jar" />
				<pathelement location="lib/junit.jar" />
			</classpath>
		</ljunit>
	</target>
	
	<target name="instrument.clean">
		<delete dir="build/instrument" />
	</target>
	
	<!-- console -->
	
	<target name="console.jspm">
		<jspm>
			<fileset dir="console/src" includes="**/*.jspm" />
		</jspm>
	</target>
	
	<target name="console.core.compile" depends="dsmf.compile, runtime.core.compile, runtime.pattern.compile, runtime.servlet.compile, console.jspm">
		<compile srcdir="console/src">
			<classpath>
				<pathelement location="build/classes/dsmf/src" />
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/patternsrc" />
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/exedio-cops.jar" />
				<pathelement location="lib/servlet-api.jar" />
			</classpath>
		</compile>
	</target>
	
	<target name="console.jar" depends="console.core.compile">
		<ljar name="cope console" jarfile="build/exedio-cope-console.jar" classpath="exedio-cope.jar exedio-cops.jar">
			<fileset dir="build/classes/console/src" />
		</ljar>
	</target>
	
	<target name="console.test.compile" depends="runtime.core.compile, runtime.servlet.compile, runtime.junit.compile, console.core.compile">
		<compile srcdir="console/testsrc">
			<classpath>
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="build/classes/runtime/junitsrc" />
				<pathelement location="build/classes/console/src" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/exedio-cops.jar" />
				<pathelement location="lib/servlet-api.jar" />
				<pathelement location="lib/junit.jar" />
			</classpath>
		</compile>
	</target>
	
	<target name="console.test" depends="dsmf.compile, runtime.core.compile, runtime.dialect.compile, runtime.pattern.compile, runtime.servlet.compile, runtime.junit.compile, console.core.compile, console.test.compile">
		<ljunit test="com.exedio.cope.console.PackageTest">
			<classpath>
				<pathelement location="build/classes/dsmf/src" />
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/dialects" />
				<pathelement location="build/classes/runtime/patternsrc" />
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="build/classes/runtime/junitsrc" />
				<pathelement location="build/classes/console/src" />
				<pathelement location="build/classes/console/testsrc" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/exedio-cops.jar" />
				<pathelement location="lib/trove.jar" />
				<pathelement location="lib/jdbc/hsqldb.jar" />
				<pathelement location="lib/junit.jar" />
			</classpath>
		</ljunit>
	</target>
	
	<target name="console.web" depends="dsmf.compile, runtime.core.compile, runtime.servlet.compile, console.core.compile">
		<compile srcdir="console/websrc">
			<classpath>
				<pathelement location="build/classes/dsmf/src" />
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/runtime/servletsrc" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/servlet-api.jar" />
			</classpath>
		</compile>
		<copy todir="console/web/WEB-INF/classes">
			<fileset dir="build/classes/runtime/src" />
			<fileset dir="build/classes/console/src" />
		</copy>
		<copy todir="console/web/WEB-INF/classes">
			<fileset dir="build/classes/console/websrc" />
		</copy>
		<copy todir="console/web/WEB-INF/lib">
			<fileset file="lib/trove.jar" />
			<fileset file="lib/exedio-cops.jar" />
			<fileset file="lib/exedio-cope-util.jar" />
			<fileset file="lib/jdbc/hsqldb.jar" />
			<fileset file="lib/jdbc/mysql-connector-java-5.0.3-bin.jar" />
		</copy>
		<copy todir="build/console/historyweb">
			<fileset dir="console/web" />
		</copy>
	</target>
	
	<target name="console.tomcat" depends="console.web, catalina">
		<copy tofile="tomcat/conf/Catalina/localhost/cope-console.xml" file="console/context.xml"/>
		<copy tofile="tomcat/conf/Catalina/localhost/cope-console-history.xml" file="console/context-history.xml"/>
		<copy todir="tomcat/bin" file="console/history.cope.properties"/>
	</target>
	
	<target name="console.compile" depends="console.core.compile, console.test.compile" />
	
	<target name="console.clean">
		<delete dir="build/console" />
		<delete dir="console/web/WEB-INF/classes" />
		<delete dir="console/web/WEB-INF/lib" />
		<delete>
			<fileset dir="console/src">
				<include name="**/*_Jspm.java" />
			</fileset>
		</delete>
	</target>
	
	<!-- common -->
	
	<target name="jspm" depends="console.jspm, copernica.test.jspm" />
	
	<target name="src" depends="jspm, index" description="creates all sources, so the IDE does not complain" />
	
	<target name="instrument" depends="runtime.servlet.test.instrument, instrument.test.instrument, runtime.test.instrument" />
	
	<target name="compile"
			  depends="runtime.compile,
			  runtime.servlet.test.web,
			  instrument.compile,
			  console.compile,
			  copernica.test.compile" />
	
	<target name="jar" depends="runtime.jar, runtime.test.jar, instrument.jar, console.jar" />
	
	<target name="teardown" depends="runtime.test.teardown" />
	
	<target name="test" depends="dsmf.test, runtime.test, instrument.test, console.test" />
	
	<target name="web" depends="runtime.web, copernica.web" />
	
	<target name="tomcat" depends="runtime.tomcat, runtime.servlet.test.tomcat, console.tomcat, copernica.tomcat" />
	
	<target name="webtest" depends="copernica.webtest" />
	
	<target name="index">
		<foreachEnvironment skipSwitch="index">
			<body>
				<mkdir dir="build/environments" />
				<copy file="environment.html" tofile="build/environments/@{env}.html">
					<filterset>
						<filter token="HOST" value="http://localhost:${tomcat.port.http}/" />
						<filter token="ENV" value="@{env}" />
					</filterset>
				</copy>
			</body>
		</foreachEnvironment>
	</target>
	
	<target name="clean" depends="dsmf.clean, runtime.clean, instrument.clean, console.clean, copernica.clean">
		<delete dir="build" />
		<delete dir="tomcat" />
	</target>
	
	<target name="api">
		<delete dir="build/api" />
		<javadoc
				destdir="build/api"
				maxmemory="60m"
				source="1.5"
				private="on"
				author="off"
				use="off"
				version="off"
				notree="true"
				noindex="true"
				failonerror="true">
			<fileset file="dsmf/src/com" includes="**/*.java" />
			<fileset file="runtime/src/com" includes="**/*.java" />
			<fileset file="runtime/patternsrc/com" includes="**/*.java" />
			<fileset file="runtime/servletsrc/com" includes="**/*.java" />
			<fileset file="runtime/junitsrc/com" includes="**/*.java" />
			<fileset file="instrument/src/com" includes="**/*.java" />
			<fileset file="instrument/antsrc/com" includes="**/*.java" />
			<fileset file="console/src/com" includes="**/*.java" />
			<classpath>
				<pathelement location="lib/trove.jar" />
				<pathelement location="lib/junit.jar" />
				<pathelement location="${ant.jar}" />
				<pathelement location="lib/bsh-core.jar" />
				<pathelement location="lib/cojen.jar" />
				<pathelement location="lib/exedio-cops.jar" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/servlet-api.jar" />
			</classpath>
		</javadoc>
	</target>
	
	<target name="testprotocol" depends="runtime.test.protocol, runtime.core.compile, console.core.compile">
		<mkdir dir="build/runtime" />
		<java classname="com.exedio.cope.console.EnvironmentCop" taskname="testprotocol"
				fork="yes" failonerror="yes">
			<classpath>
				<pathelement location="build/classes/runtime/src" />
				<pathelement location="build/classes/console/src" />
				<pathelement location="lib/trove.jar" />
				<pathelement location="lib/exedio-cops.jar" />
				<pathelement location="lib/exedio-cope-util.jar" />
				<pathelement location="lib/servlet-api.jar" />
			</classpath>
			<arg value="build/runtime/testprotocol.html"/>
			<assertions><enable/></assertions>
		</java>
		<LoadFile srcFile="build/runtime/testprotocol.html" property="testprotocol.html" />
		<copy file="runtime/testprotocol-template.html"
				tofile="build/testprotocol.html"
				overwrite="true">
			<filterset>
				<filter token="BUILD_TAG" value="${build.tag}" />
				<filter token="TABLE" value="${testprotocol.html}" />
			</filterset>
		</copy>
	</target>
	
	<target name="build"
			depends="compile, test, jar, testprotocol,
						tomcat, index,
						webtest" />
	
	<target name="findbugs.prepare">
		<untar
				compression="gzip"
				src="${basedir}/lib/findbugs-1.3.9.tar.gz"
				dest="${basedir}/build/findbugs-home" />
		<taskdef
				resource="edu/umd/cs/findbugs/anttask/tasks.properties"
				classpath="build/findbugs-home/findbugs-1.3.9/lib/findbugs-ant.jar" />
	</target>
	
	<target name="findbugs.prod" depends="findbugs.prepare, compile">
		<findbugs
					home="${basedir}/build/findbugs-home/findbugs-1.3.9"
					jvmargs="-Xmx250M"
					failOnError="true"
					warningsProperty="findbugs.warnings"
					output="html"
					outputFile="${basedir}/build/findbugs-prod.html"
					excludeFilter="findbugs-exclude.xml"
					effort="max"
					reportlevel="low">
			<class location="${basedir}/build/classes/dsmf/src" />
			<class location="${basedir}/build/classes/runtime/src" />
			<class location="${basedir}/build/classes/runtime/dialects" />
			<class location="${basedir}/build/classes/runtime/patternsrc" />
			<class location="${basedir}/build/classes/runtime/servletsrc" />
			<class location="${basedir}/build/classes/runtime/junitsrc" />
			<class location="${basedir}/build/classes/instrument/src" />
			<class location="${basedir}/build/classes/instrument/antsrc" />
			<class location="${basedir}/build/classes/console/src" />
			<auxclasspath>
				<pathelement location="${basedir}/lib/exedio-cope-util.jar" />
				<pathelement location="${basedir}/lib/exedio-cops.jar" />
				<pathelement location="${basedir}/lib/trove.jar" />
				<pathelement location="${basedir}/lib/cojen.jar" />
				<pathelement location="${basedir}/lib/bsh-core.jar" />
				<pathelement location="${basedir}/lib/commons-io.jar" />
				<pathelement location="${basedir}/lib/servlet-api.jar" />
				<pathelement location="${basedir}/lib/junit.jar" />
				<pathelement location="${ant.jar}" />
			</auxclasspath>
		</findbugs>
		<fail if="findbugs.warnings" message="findbugs warnings" />
	</target>
	
	<target name="findbugs.test" depends="findbugs.prepare, compile">
		<findbugs
					home="${basedir}/build/findbugs-home/findbugs-1.3.9"
					jvmargs="-Xmx250M"
					output="html"
					outputFile="${basedir}/build/findbugs-test.html"
					effort="max"
					reportlevel="low">
			<class location="${basedir}/build/classes/runtime/testsrc" />
			<class location="${basedir}/build/classes/console/testsrc" />
			<auxclasspath>
				<pathelement location="${basedir}/build/classes/dsmf/src" />
				<pathelement location="${basedir}/build/classes/runtime/src" />
				<pathelement location="${basedir}/build/classes/runtime/patternsrc" />
				<pathelement location="${basedir}/build/classes/runtime/servletsrc" />
				<pathelement location="${basedir}/build/classes/runtime/junitsrc" />
				<pathelement location="${basedir}/build/classes/instrument/src" />
				<pathelement location="${basedir}/build/classes/console/src" />
				<pathelement location="${basedir}/lib/exedio-cope-util.jar" />
				<pathelement location="${basedir}/lib/exedio-cops.jar" />
				<pathelement location="${basedir}/lib/trove.jar" />
				<pathelement location="${basedir}/lib/cojen.jar" />
				<pathelement location="${basedir}/lib/bsh-core.jar" />
				<pathelement location="${basedir}/lib/commons-io.jar" />
				<pathelement location="${basedir}/lib/servlet-api.jar" />
				<pathelement location="${basedir}/lib/junit.jar" />
				<pathelement location="${ant.jar}" />
			</auxclasspath>
		</findbugs>
	</target>
	
	<target name="findbugs" depends="findbugs.prod, findbugs.test" />
	
	<target name="all" depends="build, runtime.jar.src, api, findbugs" />

	<target name="cruise" depends="clean, all">
		<copy todir="${basedir}/cruise">
			<fileset file="${basedir}/getlib.properties" />
			<fileset file="${basedir}/build/exedio-cope.jar" />
			<fileset file="${basedir}/build/exedio-cope.jar-src.zip" />
			<fileset file="${basedir}/build/exedio-cope-test.jar" />
			<fileset file="${basedir}/build/exedio-cope-instrument.jar" />
			<fileset file="${basedir}/build/exedio-cope-console.jar" />
			<fileset file="${basedir}/build/testprotocol.html" />
			<fileset file="${basedir}/build/findbugs-prod.html" />
			<fileset file="${basedir}/build/findbugs-test.html" />
		</copy>
		<copy file="CHANGELOG" tofile="${basedir}/cruise/exedio-cope.jar-CHANGELOG" />
	</target>
	
	<target name="hudson" depends="all">
		<copy todir="${basedir}/build/success">
			<fileset file="${basedir}/build/exedio-cope.jar" />
			<fileset file="${basedir}/build/exedio-cope.jar-src.zip" />
			<fileset file="${basedir}/build/exedio-cope-test.jar" />
			<fileset file="${basedir}/build/exedio-cope-instrument.jar" />
			<fileset file="${basedir}/build/exedio-cope-console.jar" />
		</copy>
	</target>

</project>
