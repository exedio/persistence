/*
 * Copyright (C) 2004-2015  exedio GmbH (www.exedio.com)
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */

package com.exedio.cope;

import static com.exedio.cope.JoinWithInheritanceTest.Container.articles;
import static com.exedio.cope.JoinWithInheritanceTest.Container.specificArticles;
import static java.util.Arrays.asList;

import com.exedio.cope.pattern.ListField;
import org.junit.Test;

public class JoinWithInheritanceTest extends AbstractRuntimeModelTest
{
	static final Model MODEL = new Model(
			Container.TYPE,
			Article.TYPE,
			SpecificArticle.TYPE,
			ReallySpecificArticle.TYPE);

	static
	{
		MODEL.enableSerialization(JoinWithInheritanceTest.class, "MODEL");
	}

	public JoinWithInheritanceTest()
	{
		super(MODEL);
	}

	@Test
	@Test public void testCorrectSubtypeOfJoinWillBeUsed()
	{
		final Container container = new Container();
		container.addToArticles(new SpecificArticle());

		final Query<Container> query = Container.TYPE.newQuery();
		query.joinOuterLeft(articles.getRelationType(), articles.getParent().equalTarget());
		final Join articleJoin = query.join(SpecificArticle.TYPE);
		articleJoin.setCondition(((ItemField<?>)articles.getElement()).equalTarget(articleJoin));
		assertEquals(
				"select this from Container " +
				"left join Container-articles c1 on Container-articles.parent=this " +
				"join SpecificArticle s2 on Container-articles.element=s2.SpecificArticle.this",
				query.toString());
		assertEquals(asList(container), query.search());
	}

	@Test
	@Test public void testCorrectSubtypeOfJoinWillBeUsedEmptyResult()
	{
		final Container container = new Container();
		container.addToArticles(new SpecificArticle());

		final Query<Container> query = Container.TYPE.newQuery();
		query.joinOuterLeft(specificArticles.getRelationType(), specificArticles.getParent()
				.equalTarget());
		final Join articleJoin = query.join(ReallySpecificArticle.TYPE);
		articleJoin.setCondition(((ItemField<?>)specificArticles.getElement()).equalTarget(articleJoin));
		assertEquals(
				"select this from Container " +
				"left join Container-specificArticles c1 on Container-specificArticles.parent=this " +
				"join ReallySpecificArticle r2 on Container-specificArticles.element=r2.ReallySpecificArticle.this",
				query.toString());
		assertEquals(asList(), query.search());
	}

	@Test
	@Test public void testSuperTypeCastNotAllowed()
	{
		final Container container = new Container();
		container.addToArticles(new SpecificArticle());

		final Query<Container> query = Container.TYPE.newQuery();
		query.joinOuterLeft(specificArticles.getRelationType(), specificArticles.getParent().equalTarget());
		final Join articleJoin = query.join(Article.TYPE);
		try
		{
			((ItemField<?>)specificArticles.getElement()).equalTarget(articleJoin);
			fail("exception expected");
		}
		catch(final ClassCastException e)
		{
			assertEquals("expected a SpecificArticle, but was a Article", e.getMessage());
		}
	}

	@Test
	@Test public void testInvalidJoinIsBound()
	{
		final Container container = new Container();
		container.addToArticles(new SpecificArticle());

		final Query<Container> query = Container.TYPE.newQuery();
		final Join test = query.joinOuterLeft(articles.getRelationType(), articles.getParent()
				.equalTarget());
		query.join(SpecificArticle.TYPE);
		try
		{
			((ItemField<?>)articles.getElement()).equalTarget(test);
			fail("exception expected");
		}
		catch(final ClassCastException e)
		{
			assertEquals("expected a Article, but was a Container-articles", e.getMessage());
		}
	}

	static class Container extends Item
	{
		static final ListField<Article> articles = ListField.create(ItemField.create(Article.class));
		static final ListField<SpecificArticle> specificArticles = ListField.create(ItemField.create(SpecificArticle.class));

	/**

	 **
	 * Creates a new Container with all the fields initially needed.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tags <tt>@cope.constructor public|package|protected|private|none</tt> in the class comment and <tt>@cope.initial</tt> in the comment of fields.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	Container()
	{
		this(new com.exedio.cope.SetValue<?>[]{
		});
	}/**

	 **
	 * Creates a new Container and sets the given fields initially.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.generic.constructor public|package|protected|private|none</tt> in the class comment.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	protected Container(final com.exedio.cope.SetValue<?>... setValues)
	{
		super(setValues);
	}/**

	 **
	 * Returns the value of {@link #articles}.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.get public|package|protected|private|none|non-final</tt> in the comment of the field.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	final java.util.List<Article> getArticles()
	{
		return Container.articles.get(this);
	}/**

	 **
	 * Returns a query for the value of {@link #articles}.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.getQuery public|package|protected|private|none|non-final</tt> in the comment of the field.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	final com.exedio.cope.Query<Article> getArticlesQuery()
	{
		return Container.articles.getQuery(this);
	}/**

	 **
	 * Returns the items, for which field list {@link #articles} contains the given element.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.getDistinctParentsOf public|package|protected|private|none|non-final</tt> in the comment of the field.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	static final java.util.List<Container> getDistinctParentsOfArticles(final Article element)
	{
		return Container.articles.getDistinctParents(Container.class,element);
	}/**

	 **
	 * Adds a new value for {@link #articles}.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.addTo public|package|protected|private|none|non-final</tt> in the comment of the field.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	final void addToArticles(final Article articles)
			throws
				com.exedio.cope.MandatoryViolationException,
				java.lang.ClassCastException
	{
		Container.articles.add(this,articles);
	}/**

	 **
	 * Sets a new value for {@link #articles}.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.set public|package|protected|private|none|non-final</tt> in the comment of the field.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	final void setArticles(final java.util.Collection<? extends Article> articles)
			throws
				com.exedio.cope.MandatoryViolationException,
				java.lang.ClassCastException
	{
		Container.articles.set(this,articles);
	}/**

	 **
	 * Returns the parent field of the type of {@link #articles}.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.Parent public|package|protected|private|none|non-final</tt> in the comment of the field.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	static final com.exedio.cope.ItemField<Container> articlesParent()
	{
		return Container.articles.getParent(Container.class);
	}/**

	 **
	 * Returns the value of {@link #specificArticles}.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.get public|package|protected|private|none|non-final</tt> in the comment of the field.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	final java.util.List<SpecificArticle> getSpecificArticles()
	{
		return Container.specificArticles.get(this);
	}/**

	 **
	 * Returns a query for the value of {@link #specificArticles}.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.getQuery public|package|protected|private|none|non-final</tt> in the comment of the field.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	final com.exedio.cope.Query<SpecificArticle> getSpecificArticlesQuery()
	{
		return Container.specificArticles.getQuery(this);
	}/**

	 **
	 * Returns the items, for which field list {@link #specificArticles} contains the given element.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.getDistinctParentsOf public|package|protected|private|none|non-final</tt> in the comment of the field.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	static final java.util.List<Container> getDistinctParentsOfSpecificArticles(final SpecificArticle element)
	{
		return Container.specificArticles.getDistinctParents(Container.class,element);
	}/**

	 **
	 * Adds a new value for {@link #specificArticles}.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.addTo public|package|protected|private|none|non-final</tt> in the comment of the field.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	final void addToSpecificArticles(final SpecificArticle specificArticles)
			throws
				com.exedio.cope.MandatoryViolationException,
				java.lang.ClassCastException
	{
		Container.specificArticles.add(this,specificArticles);
	}/**

	 **
	 * Sets a new value for {@link #specificArticles}.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.set public|package|protected|private|none|non-final</tt> in the comment of the field.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	final void setSpecificArticles(final java.util.Collection<? extends SpecificArticle> specificArticles)
			throws
				com.exedio.cope.MandatoryViolationException,
				java.lang.ClassCastException
	{
		Container.specificArticles.set(this,specificArticles);
	}/**

	 **
	 * Returns the parent field of the type of {@link #specificArticles}.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.Parent public|package|protected|private|none|non-final</tt> in the comment of the field.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	static final com.exedio.cope.ItemField<Container> specificArticlesParent()
	{
		return Container.specificArticles.getParent(Container.class);
	}/**

	 **
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	private static final long serialVersionUID = 1l;/**

	 **
	 * The persistent type information for container.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.type public|package|protected|private|none</tt> in the class comment.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	static final com.exedio.cope.Type<Container> TYPE = com.exedio.cope.TypesBound.newType(Container.class);/**

	 **
	 * Activation constructor. Used for internal purposes only.
	 * @see com.exedio.cope.Item#Item(com.exedio.cope.ActivationParameters)
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	protected Container(final com.exedio.cope.ActivationParameters ap){super(ap);
}}

	static abstract class Article extends Item
	{
	/**

	 **
	 * Creates a new Article with all the fields initially needed.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tags <tt>@cope.constructor public|package|protected|private|none</tt> in the class comment and <tt>@cope.initial</tt> in the comment of fields.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	Article()
	{
		this(new com.exedio.cope.SetValue<?>[]{
		});
	}/**

	 **
	 * Creates a new Article and sets the given fields initially.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.generic.constructor public|package|protected|private|none</tt> in the class comment.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	protected Article(final com.exedio.cope.SetValue<?>... setValues)
	{
		super(setValues);
	}/**

	 **
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	private static final long serialVersionUID = 1l;/**

	 **
	 * The persistent type information for article.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.type public|package|protected|private|none</tt> in the class comment.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	static final com.exedio.cope.Type<Article> TYPE = com.exedio.cope.TypesBound.newType(Article.class);/**

	 **
	 * Activation constructor. Used for internal purposes only.
	 * @see com.exedio.cope.Item#Item(com.exedio.cope.ActivationParameters)
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	protected Article(final com.exedio.cope.ActivationParameters ap){super(ap);
}}

	static class SpecificArticle extends Article
	{
	/**

	 **
	 * Creates a new SpecificArticle with all the fields initially needed.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tags <tt>@cope.constructor public|package|protected|private|none</tt> in the class comment and <tt>@cope.initial</tt> in the comment of fields.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	SpecificArticle()
	{
		this(new com.exedio.cope.SetValue<?>[]{
		});
	}/**

	 **
	 * Creates a new SpecificArticle and sets the given fields initially.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.generic.constructor public|package|protected|private|none</tt> in the class comment.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	protected SpecificArticle(final com.exedio.cope.SetValue<?>... setValues)
	{
		super(setValues);
	}/**

	 **
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	private static final long serialVersionUID = 1l;/**

	 **
	 * The persistent type information for specificArticle.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.type public|package|protected|private|none</tt> in the class comment.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	static final com.exedio.cope.Type<SpecificArticle> TYPE = com.exedio.cope.TypesBound.newType(SpecificArticle.class);/**

	 **
	 * Activation constructor. Used for internal purposes only.
	 * @see com.exedio.cope.Item#Item(com.exedio.cope.ActivationParameters)
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	protected SpecificArticle(final com.exedio.cope.ActivationParameters ap){super(ap);
}}

	static class ReallySpecificArticle extends SpecificArticle
	{
	/**

	 **
	 * Creates a new ReallySpecificArticle with all the fields initially needed.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tags <tt>@cope.constructor public|package|protected|private|none</tt> in the class comment and <tt>@cope.initial</tt> in the comment of fields.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	ReallySpecificArticle()
	{
		this(new com.exedio.cope.SetValue<?>[]{
		});
	}/**

	 **
	 * Creates a new ReallySpecificArticle and sets the given fields initially.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.generic.constructor public|package|protected|private|none</tt> in the class comment.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	protected ReallySpecificArticle(final com.exedio.cope.SetValue<?>... setValues)
	{
		super(setValues);
	}/**

	 **
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	private static final long serialVersionUID = 1l;/**

	 **
	 * The persistent type information for reallySpecificArticle.
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 *       It can be customized with the tag <tt>@cope.type public|package|protected|private|none</tt> in the class comment.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	static final com.exedio.cope.Type<ReallySpecificArticle> TYPE = com.exedio.cope.TypesBound.newType(ReallySpecificArticle.class);/**

	 **
	 * Activation constructor. Used for internal purposes only.
	 * @see com.exedio.cope.Item#Item(com.exedio.cope.ActivationParameters)
	 * @cope.generated This feature has been generated by the cope instrumentor and will be overwritten by the build process.
	 */
	@javax.annotation.Generated("com.exedio.cope.instrument")
	protected ReallySpecificArticle(final com.exedio.cope.ActivationParameters ap){super(ap);
}}
}
